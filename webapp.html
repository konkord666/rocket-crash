<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket Crash</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: white;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes pulse-glow-gold {
            0%, 100% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.5), 0 0 50px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 35px rgba(255, 215, 0, 0.7), 0 0 70px rgba(255, 215, 0, 0.4); }
        }
        
        @keyframes pulse-glow-silver {
            0%, 100% { box-shadow: 0 0 20px rgba(192, 192, 192, 0.4), 0 0 40px rgba(192, 192, 192, 0.2); }
            50% { box-shadow: 0 0 30px rgba(192, 192, 192, 0.6), 0 0 60px rgba(192, 192, 192, 0.3); }
        }
        
        @keyframes pulse-glow-bronze {
            0%, 100% { box-shadow: 0 0 20px rgba(205, 127, 50, 0.4), 0 0 40px rgba(205, 127, 50, 0.2); }
            50% { box-shadow: 0 0 30px rgba(205, 127, 50, 0.6), 0 0 60px rgba(205, 127, 50, 0.3); }
        }
        
        .leaderboard-item.top1-glow {
            animation: pulse-glow-gold 2s ease-in-out infinite;
        }
        
        .leaderboard-item.top2-glow {
            animation: pulse-glow-silver 2s ease-in-out infinite;
        }
        
        .leaderboard-item.top3-glow {
            animation: pulse-glow-bronze 2s ease-in-out infinite;
        }
        
        .container {
            max-width: 480px;
            width: 100%;
            height: 100vh;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #0f1419;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                box-shadow: none;
            }
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: transparent;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .top-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .top-btn-add {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            justify-content: center;
            font-size: 1.1em;
        }
        
        .top-btn-add:active {
            transform: scale(0.95);
        }
        
        .top-btn-users {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0;
            background: #0f1419;
            border-top: 1px solid rgba(59, 130, 246, 0.15);
            z-index: 1000;
            flex-shrink: 0;
        }
        
        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 6px 0;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.7em;
            height: 100%;
        }
        
        .nav-btn.active {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .nav-btn:active {
            background: rgba(59, 130, 246, 0.15);
        }
        
        .nav-btn-icon {
            font-size: 1.5em;
            line-height: 1;
        }
        
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .case-card {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%);
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .case-card:hover {
            transform: translateY(-5px);
            border-color: #FFC107;
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.3);
        }
        
        .case-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .case-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #FFC107;
            margin-bottom: 5px;
        }
        
        .case-price {
            font-size: 1.1em;
            color: white;
            margin-bottom: 5px;
        }
        
        .case-range {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .case-opening {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .case-opening-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin-bottom: 30px;
        }
        
        .case-opening-header h2 {
            color: #FFC107;
            font-size: 1.5em;
        }
        
        .case-close-btn {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .case-close-btn:hover {
            background: rgba(255, 193, 7, 0.3);
            transform: rotate(90deg);
        }
        
        .case-reel-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 150px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .case-reel {
            display: flex;
            position: absolute;
            left: 0;
            transition: left 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .case-item {
            min-width: 120px;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            border-radius: 10px;
            border: 2px solid;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .case-item.common {
            background: linear-gradient(135deg, rgba(128, 128, 128, 0.3) 0%, rgba(100, 100, 100, 0.2) 100%);
            border-color: rgba(128, 128, 128, 0.5);
        }
        
        .case-item.rare {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(56, 142, 60, 0.2) 100%);
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .case-item.epic {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 152, 0, 0.2) 100%);
            border-color: rgba(255, 193, 7, 0.5);
        }
        
        .case-item.legendary {
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.3) 0%, rgba(244, 67, 54, 0.2) 100%);
            border-color: rgba(255, 87, 34, 0.5);
        }
        
        .case-item-amount {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
            line-height: 1;
        }
        
        .case-item-icon {
            font-size: 3em;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .case-item-name {
            font-size: 0.75em;
            color: white;
            text-align: center;
            margin-bottom: 5px;
            line-height: 1.2;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .case-item-type {
            font-size: 0.65em;
            color: #FFC107;
            font-weight: bold;
            background: rgba(255, 193, 7, 0.3);
            padding: 3px 8px;
            border-radius: 5px;
            text-transform: uppercase;
        }
        
        .case-selector {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #FFC107;
            transform: translateX(-50%);
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
            z-index: 10;
        }
        
        .case-result {
            text-align: center;
            margin-top: 30px;
        }
        
        .case-result-title {
            font-size: 2em;
            color: #FFC107;
            margin-bottom: 15px;
        }
        
        .case-result-amount {
            font-size: 3em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
        }
        
        .upgrade-container {
            margin-top: 20px;
        }
        
        .upgrade-bet-input {
            width: 100%;
            padding: 18px;
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 12px;
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 15px;
            background: rgba(30, 35, 45, 0.6);
            color: #3b82f6;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .upgrade-bet-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 35, 45, 0.8);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }
        
        .upgrade-multipliers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .multiplier-btn {
            padding: 15px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            background: rgba(30, 35, 45, 0.6);
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .multiplier-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }
        
        .multiplier-btn.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(37, 99, 235, 0.2) 100%);
        }
        
        .multiplier-chance {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            display: block;
            margin-top: 5px;
        }
        
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 30px auto;
        }
        
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            border: 5px solid rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.3);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #3b82f6;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.8));
            z-index: 10;
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            border: 4px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            z-index: 5;
        }
        
        .upgrade-result {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            display: none;
        }
        
        .upgrade-result.win {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(56, 142, 60, 0.1) 100%);
            border: 2px solid rgba(76, 175, 80, 0.5);
        }
        
        .upgrade-result.lose {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(211, 47, 47, 0.1) 100%);
            border: 2px solid rgba(244, 67, 54, 0.5);
        }
        
        .upgrade-result-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .upgrade-result-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .double-container {
            margin-top: 20px;
        }
        
        .double-bet-input {
            width: 100%;
            padding: 18px;
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 12px;
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 15px;
            background: rgba(30, 35, 45, 0.6);
            color: #3b82f6;
            font-weight: bold;
        }
        
        .double-multipliers {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .double-btn {
            padding: 15px 10px;
            border: 2px solid;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .double-btn.double-x2 {
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            border-color: #444;
        }
        
        .double-btn.double-x3 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
        }
        
        .double-btn.double-x5 {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            border-color: #f44336;
        }
        
        .double-btn.double-x50 {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            border-color: #4CAF50;
        }
        
        .double-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }
        
        .double-multi {
            font-size: 1.2em;
        }
        
        .double-chance {
            font-size: 0.7em;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        .double-wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 30px auto;
        }
        
        .double-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            border: 5px solid rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
            overflow: hidden;
        }
        
        .double-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            clip-path: polygon(100% 100%, 0 100%, 50% 0);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10px;
        }
        
        .double-segment-text {
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
        }
        
        .double-wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #3b82f6;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.8));
            z-index: 10;
        }
        
        .double-wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            border: 4px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            z-index: 5;
        }
        
        .double-result {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            display: none;
        }
        
        .double-result.win {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(56, 142, 60, 0.1) 100%);
            border: 2px solid rgba(76, 175, 80, 0.5);
        }
        
        .double-result.lose {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(211, 47, 47, 0.1) 100%);
            border: 2px solid rgba(244, 67, 54, 0.5);
        }
        
        .double-result-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .double-result-amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #3b82f6;
        }
        
        #casesPage {
            height: calc(100vh - 60px);
            overflow: hidden;
            padding: 8px;
            background: #0f1419;
            display: flex;
            flex-direction: column;
        }
        
        #upgradePage {
            height: calc(100vh - 60px);
            overflow: hidden;
            padding: 10px;
            background: #0f1419;
            display: flex;
            flex-direction: column;
        }
        
        .stock-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        
        .stock-chart {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1e 100%);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 8px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            position: relative;
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #stockCanvas {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        .stock-price {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: #3b82f6;
            background: rgba(15, 20, 25, 0.8);
            padding: 5px 10px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }
        
        .stock-timer {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: #eab308;
            background: rgba(15, 20, 25, 0.8);
            padding: 5px 10px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }
        
        .stock-result {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-weight: bold;
            display: none;
        }
        
        .stock-result.win {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid rgba(34, 197, 94, 0.5);
            color: #22c55e;
        }
        
        .stock-result.lose {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        
        .stock-trades {
            flex: 1;
            overflow-y: auto;
            background: rgba(30, 35, 45, 0.4);
            border-radius: 8px;
            padding: 8px;
            min-height: 60px;
        }
        
        .stock-trades::-webkit-scrollbar {
            width: 4px;
        }
        
        .stock-trades::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 2px;
        }
        
        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(30, 35, 45, 0.6);
            border-radius: 6px;
            font-size: 0.85em;
        }
        
        .trade-item.up {
            border-left: 3px solid #22c55e;
        }
        
        .trade-item.down {
            border-left: 3px solid #ef4444;
        }
        
        #casesPage h1 {
            background: linear-gradient(90deg, #8b5cf6, #3b82f6, #06b6d4, #3b82f6, #8b5cf6);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: neonGlow 3s linear infinite;
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.5),
                         0 0 40px rgba(59, 130, 246, 0.3),
                         0 0 60px rgba(6, 182, 212, 0.2);
            filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.8))
                    drop-shadow(0 0 20px rgba(59, 130, 246, 0.6));
        }
        
        @keyframes neonGlow {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }
        
        .plinko-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        
        .plinko-bet-input {
            width: 100%;
            padding: 8px;
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
            margin-bottom: 6px;
            background: rgba(30, 35, 45, 0.6);
            color: #3b82f6;
            font-weight: bold;
        }
        
        .plinko-board {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1e 100%);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 6px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        #plinkoCanvas {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        .plinko-result {
            text-align: center;
            padding: 6px;
            border-radius: 8px;
            display: none;
            background: rgba(30, 35, 45, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.3);
        }
        
        .plinko-result.win {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(56, 142, 60, 0.1) 100%);
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .plinko-result.lose {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(211, 47, 47, 0.1) 100%);
            border-color: rgba(244, 67, 54, 0.5);
        }
        
        .plinko-result-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .plinko-result-amount {
            font-size: 1em;
            font-weight: bold;
            color: #3b82f6;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .history-bar {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            padding: 8px 12px;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            z-index: 100;
            background: rgba(15, 20, 25, 0.5);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .history-bar::-webkit-scrollbar {
            display: none;
        }
        
        .history-item {
            min-width: 52px;
            padding: 8px 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            font-size: 0.85em;
            background: rgba(15, 20, 25, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            flex-shrink: 0;
        }
        
        .history-item.low {
            color: rgba(239, 68, 68, 0.8);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .history-item.medium {
            color: rgba(59, 130, 246, 0.8);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .history-item.high {
            color: rgba(34, 197, 94, 0.8);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .timer-bar {
            text-align: center;
            padding: 10px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .players-list {
            flex: 1;
            overflow-y: auto;
            background: rgba(30, 35, 45, 0.4);
            border-radius: 8px;
            padding: 8px;
            min-height: 60px;
            max-height: 120px;
        }
        
        .players-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .players-list::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 2px;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 5px;
            background: rgba(30, 35, 45, 0.6);
            border-radius: 8px;
            font-size: 0.85em;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .player-name {
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .player-bet {
            color: #3b82f6;
        }
        
        .player-result {
            font-weight: bold;
        }
        
        .player-result.win {
            color: #22c55e;
        }
        
        .player-result.loss {
            color: #ef4444;
        }
        
        .balance {
            position: absolute;
            top: 10px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            padding: 8px 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.1) 100%);
            border-radius: 20px;
            border: 2px solid rgba(59, 130, 246, 0.4);
            color: #3b82f6;
            font-weight: bold;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        
        .balance-add-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            transition: all 0.2s;
            box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
        }
        
        .balance-add-btn:active {
            transform: scale(0.9);
        }
        
        .game-area {
            width: 100%;
            height: 50vh;
            position: relative;
            overflow: hidden;
            background-image: url('sp.gif');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            flex-shrink: 0;
        }
        
        .game-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(15, 20, 25, 0.2) 100%);
            z-index: 1;
            pointer-events: none;
        }
        
        .graph-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .graph-line {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: calc(100% - 40px);
            height: calc(100% - 40px);
        }
        
        .rocket {
            position: absolute;
            width: 70px;
            height: 70px;
            background-image: url('Rocket.webp');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: all 0.1s linear;
            filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.8));
            z-index: 50;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .rocket.crashed {
            animation: rocketExplosion 0.5s ease-out;
        }
        
        .rocket.crashed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            z-index: 100;
        }
        
        @keyframes rocketExplosion {
            0% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.5) rotate(10deg); opacity: 0.7; }
            100% { transform: translateX(-50%) scale(2) rotate(-10deg); opacity: 0; }
        }
        
        .obstacle {
            position: absolute;
            font-size: 3em;
            bottom: 20px;
            z-index: 5;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
            display: none;
        }
        
        .multiplier {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.9), 0 0 15px rgba(0, 0, 0, 0.8);
            z-index: 50;
            color: #3b82f6;
            pointer-events: none;
        }
        
        .multiplier.growing {
            animation: pulse 0.3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.15); }
        }
        
        .trail {
            position: absolute;
            width: 3px;
            background: linear-gradient(to top, 
                rgba(255, 100, 100, 0.8),
                rgba(255, 150, 100, 0.4),
                transparent
            );
            border-radius: 2px;
            pointer-events: none;
            z-index: 1;
        }
        
        .grid-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0.1;
            z-index: 1;
        }
        
        .grid-line-h {
            position: absolute;
            width: 100%;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            left: 0;
        }
        
        .grid-line-v {
            position: absolute;
            width: 1px;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            top: 0;
        }
        
        .crash-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            color: #ef4444;
            text-shadow: 0 0 40px rgba(239, 68, 68, 0.9), 0 0 20px rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none;
        }
        
        .crash-text.show {
            display: block;
            animation: crashAppear 0.5s ease-out;
        }
        
        @keyframes crashAppear {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .controls {
            height: calc(50vh - 60px);
            padding: 10px 12px;
            background: #0f1419;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .controls::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        .bet-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 10px;
            font-size: 1.1em;
            text-align: center;
            margin-bottom: 8px;
            background: rgba(30, 35, 45, 0.8);
            color: #3b82f6;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .bet-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 35, 45, 0.9);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            margin-bottom: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .bet-input::placeholder {
            color: rgba(59, 130, 246, 0.5);
        }
        
        .status {
            text-align: center;
            font-size: 0.85em;
            padding: 6px;
            background: rgba(30, 35, 45, 0.6);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 6px;
        }
        

        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            border: 2px solid rgba(59, 130, 246, 0.5);
        }
        
        .profile-details {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 8px;
        }
        
        .profile-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        #crashPage, #profilePage {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .profile-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            font-size: 1em;
        }
        
        .profile-stat-row:last-child {
            border-bottom: none;
        }
        
        .profile-stat-row span:first-child {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .profile-stat-row span:last-child {
            color: #3b82f6;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- Страница выбора игр -->
        <div id="gamesPage" style="display: block; height: calc(100vh - 60px); overflow-y: auto; padding: 15px; padding-bottom: 80px; background: #0f1419;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 style="margin: 0; font-size: 1.8em;">🎮 Игры</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; font-size: 0.9em;">
                        <span>👥</span>
                        <span id="onlineUsersGames">1</span>
                    </div>
                    <div style="padding: 6px 12px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 8px; font-size: 0.9em; font-weight: bold;">
                        <span id="balanceGames">0</span> ⭐
                    </div>
                </div>
            </div>
            
            <!-- Лента выигрышей (бегущая строка) -->
            <div style="background: rgba(30, 35, 45, 0.6); border-radius: 15px; padding: 10px; margin-bottom: 15px; border: 1px solid rgba(59, 130, 246, 0.2); overflow: hidden; position: relative;">
                <div style="font-size: 0.85em; color: rgba(255,255,255,0.6); margin-bottom: 6px; font-weight: bold;">🔥 Последние выигрыши</div>
                <div style="overflow: hidden; position: relative; height: 35px;">
                    <div id="winsFeed" style="display: flex; gap: 10px; animation: scroll-wins 20s linear infinite; white-space: nowrap;">
                        <div style="color: rgba(255,255,255,0.4); padding: 8px;">Загрузка...</div>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes scroll-wins {
                    0% { transform: translateX(0); }
                    100% { transform: translateX(-50%); }
                }
            </style>
            
            <!-- Карточки игр -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <div onclick="openGame('crash')" style="position: relative; height: 120px; border-radius: 12px; overflow: hidden; cursor: pointer; border: 2px solid rgba(59, 130, 246, 0.3); transition: all 0.3s;">
                    <img src="crash.gif" style="width: 100%; height: 100%; object-fit: cover; position: absolute;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(15, 20, 25, 0.3), rgba(15, 20, 25, 0.85)); display: flex; flex-direction: column; justify-content: flex-end; padding: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 3px;">🚀</div>
                        <div style="font-weight: bold; font-size: 1em;">Краш</div>
                        <div style="font-size: 0.7em; color: rgba(255,255,255,0.6);">Успей выйти!</div>
                    </div>
                </div>
                
                <div onclick="openGame('plinko')" style="position: relative; height: 120px; border-radius: 12px; overflow: hidden; cursor: pointer; border: 2px solid rgba(59, 130, 246, 0.3); transition: all 0.3s;">
                    <img src="plinko.gif" style="width: 100%; height: 100%; object-fit: cover; position: absolute;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(15, 20, 25, 0.3), rgba(15, 20, 25, 0.85)); display: flex; flex-direction: column; justify-content: flex-end; padding: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 3px;">🎯</div>
                        <div style="font-weight: bold; font-size: 1em;">Plinko</div>
                        <div style="font-size: 0.7em; color: rgba(255,255,255,0.6);">Удача решает!</div>
                    </div>
                </div>
                
                <div onclick="openGame('roulette')" style="position: relative; height: 120px; border-radius: 12px; overflow: hidden; cursor: pointer; border: 2px solid rgba(59, 130, 246, 0.3); transition: all 0.3s;">
                    <img src="rule.gif" style="width: 100%; height: 100%; object-fit: cover; position: absolute;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(15, 20, 25, 0.3), rgba(15, 20, 25, 0.85)); display: flex; flex-direction: column; justify-content: flex-end; padding: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 3px;">🎰</div>
                        <div style="font-weight: bold; font-size: 1em;">Рулетка</div>
                        <div style="font-size: 0.7em; color: rgba(255,255,255,0.6);">Ставь на цвет!</div>
                    </div>
                </div>
                
                <div style="position: relative; height: 120px; border-radius: 12px; overflow: hidden; background: rgba(30, 35, 45, 0.6); border: 2px solid rgba(59, 130, 246, 0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px;">
                    <div style="font-size: 1.5em; margin-bottom: 3px; opacity: 0.3;">🎲</div>
                    <div style="font-weight: bold; font-size: 1em; color: rgba(255,255,255,0.4);">Скоро</div>
                    <div style="font-size: 0.7em; color: rgba(255,255,255,0.3);">В разработке</div>
                </div>
            </div>
        </div>
        
        <div id="crashPage" style="display: none; flex-direction: column; height: 100%; width: 100%; overflow: hidden;">
        <div class="game-area" id="gameArea">
            <div class="top-bar" id="topBar">
                <button onclick="backToGames()" style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: white; cursor: pointer; font-weight: bold; font-size: 0.85em;">← Назад</button>
                <button class="top-btn top-btn-users" id="usersBtn">
                    <span>👥</span>
                    <span id="onlineUsers">1</span>
                </button>
                <div class="balance">
                    <span id="balance">0</span>
                    <button class="balance-add-btn" onclick="topUp()">+</button>
                </div>
            </div>
            
            <canvas id="graphCanvas" style="position: absolute; width: 100%; height: 100%; z-index: 2;"></canvas>
            <div class="rocket" id="rocket"></div>
            <div class="multiplier" id="multiplier">1.00x</div>
            <div class="crash-text" id="crashText">💥 CRASHED!</div>
            
            <div class="history-bar" id="historyBar">
                <!-- История будет заполняться динамически -->
            </div>
        </div>
        
        <div class="controls">
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <input type="number" class="bet-input" id="betInput" placeholder="Ставка" min="10" value="100" style="flex: 1; margin-bottom: 0;">
                <button class="btn btn-primary" id="playBtn" onclick="startGame()" style="flex: 1; margin-bottom: 0;">🚀 Ставка</button>
            </div>
            
            <div class="status" id="status">Сделайте ставку для начала игры</div>
            
            <div class="players-list" id="playersList">
                <div style="text-align: center; color: rgba(255,255,255,0.4); font-size: 0.9em; padding: 20px;">
                    История ставок появится здесь
                </div>
            </div>
        </div>
        </div>
        
        <div id="casesPage" style="display: none; position: relative;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 6px;">
                <button onclick="backToGames()" style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: white; cursor: pointer; font-weight: bold; font-size: 0.85em;">← Назад</button>
                <h1 style="margin: 0; font-size: 1.2em;">🎯 Plinko</h1>
            </div>
            
            <div class="plinko-container">
                <!-- Выбор режима -->
                <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                    <button class="plinko-mode-btn active" onclick="selectPlinkoMode('low')" id="plinkoModeLow" style="flex: 1; padding: 8px; font-size: 0.85em; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        🟢 Низкий<br><span style="font-size: 0.75em; opacity: 0.8;">x0.8-x5</span>
                    </button>
                    <button class="plinko-mode-btn" onclick="selectPlinkoMode('medium')" id="plinkoModeMedium" style="flex: 1; padding: 8px; font-size: 0.85em; background: rgba(30, 35, 45, 0.6); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; color: rgba(255,255,255,0.6); cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        🟡 Средний<br><span style="font-size: 0.75em; opacity: 0.8;">x0.5-x10</span>
                    </button>
                    <button class="plinko-mode-btn" onclick="selectPlinkoMode('high')" id="plinkoModeHigh" style="flex: 1; padding: 8px; font-size: 0.85em; background: rgba(30, 35, 45, 0.6); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; color: rgba(255,255,255,0.6); cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        🔴 Высокий<br><span style="font-size: 0.75em; opacity: 0.8;">x0.3-x20</span>
                    </button>
                </div>
                
                <div class="plinko-board" id="plinkoBoard">
                    <canvas id="plinkoCanvas" width="280" height="340"></canvas>
                </div>
                
                <div style="display: flex; gap: 6px; margin-bottom: 6px;">
                    <input type="number" class="plinko-bet-input" id="plinkoBetInput" placeholder="Ставка" min="10" value="50" style="flex: 1; margin-bottom: 0;">
                    <button class="btn btn-primary" onclick="dropBall()" id="plinkoBtn" style="flex: 1; margin-bottom: 0; padding: 8px; font-size: 0.95em;">
                        🎯 Играть
                    </button>
                </div>
                
                <div class="plinko-result" id="plinkoResult">
                    <div class="plinko-result-title" id="plinkoResultTitle" style="font-size: 1em; margin-bottom: 2px;"></div>
                    <div class="plinko-result-amount" id="plinkoResultAmount" style="font-size: 0.95em;"></div>
                </div>
            </div>
        </div>
        
        <div id="upgradePage" style="display: none; height: calc(100vh - 60px); overflow: hidden; background: #0f1419; position: relative;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0;">
                <button onclick="backToGames()" style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: white; cursor: pointer; font-weight: bold; font-size: 0.85em;">← Назад</button>
                <h1 style="margin: 0; font-size: 1.4em;">🎰 Рулетка</h1>
            </div>
            
            <div style="display: flex; flex-direction: column; height: calc(100% - 50px); padding: 10px;">
                <!-- Линейная рулетка -->
                <div style="height: 120px; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 8px; background-image: url('sea2.gif'); background-size: cover; background-position: center; border-radius: 12px; border: 2px solid rgba(59, 130, 246, 0.3); overflow: hidden;">
                    <!-- Затемнение фона -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 1;"></div>
                    
                    <!-- Бегущая строка с числами -->
                    <div id="rouletteStrip" style="position: absolute; display: flex; white-space: nowrap; transition: left 4s cubic-bezier(0.25, 0.1, 0.25, 1); z-index: 2;"></div>
                    
                    <!-- Размытие по краям (туман) -->
                    <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 100px; background: linear-gradient(to right, rgba(15, 15, 30, 0.9), transparent); z-index: 5; pointer-events: none;"></div>
                    <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 100px; background: linear-gradient(to left, rgba(15, 15, 30, 0.9), transparent); z-index: 5; pointer-events: none;"></div>
                    
                    <!-- Стрелка вверху -->
                    <div style="position: absolute; width: 4px; height: 100%; background: linear-gradient(to bottom, transparent, #fbbf24, transparent); z-index: 10; box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);"></div>
                    <div style="position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%); font-size: 3em; z-index: 11; color: #fbbf24; filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.8));">▼</div>
                    
                    <!-- Результат -->
                    <div id="rouletteResult" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 2em; font-weight: bold; color: white; text-shadow: 0 0 20px rgba(0,0,0,0.8); display: none; z-index: 12; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px;"></div>
                </div>
                
                <!-- Таймер -->
                <div id="rouletteTimer" style="text-align: center; padding: 6px; background: rgba(255, 193, 7, 0.1); border-radius: 6px; margin-bottom: 6px; font-size: 0.9em; font-weight: bold; border: 1px solid rgba(255, 193, 7, 0.2);">
                    Ожидание...
                </div>
                
                <button onclick="toggleRouletteBets()" id="rouletteToggle" style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: white; margin-bottom: 8px; cursor: pointer; font-weight: bold;">▼ Панель ставок</button>
                
                <div id="rouletteBetsPanel" style="display: block;">
                    <!-- Ставка и кнопка -->
                    <div style="display: flex; gap: 4px; margin-bottom: 6px;">
                        <input type="number" id="rouletteBetInput" placeholder="Ставка" min="10" value="50" style="width: 80px; padding: 6px; border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 6px; background: rgba(30, 35, 45, 0.6); color: #3b82f6; font-weight: bold; text-align: center; font-size: 0.9em;">
                        <button onclick="placeRouletteBet()" id="rouletteBtn" style="flex: 1; padding: 6px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 0.9em;">
                            🎰 Ставка
                        </button>
                    </div>
                    
                    <!-- Выбор (компактно) -->
                    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin-bottom: 6px; max-height: 80px; overflow-y: auto; padding: 4px; background: rgba(30, 35, 45, 0.4); border-radius: 6px;">
                    <button onclick="selectRouletteBet('red')" class="roulette-bet-btn" data-type="red" style="padding: 6px 4px; background: #dc2626; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">🔴</button>
                    <button onclick="selectRouletteBet('black')" class="roulette-bet-btn" data-type="black" style="padding: 6px 4px; background: #1a1a1a; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">⚫</button>
                    <button onclick="selectRouletteBet(0)" class="roulette-bet-btn" data-type="0" style="padding: 6px 4px; background: #16a34a; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">0</button>
                    <button onclick="selectRouletteBet('00')" class="roulette-bet-btn" data-type="00" style="padding: 6px 4px; background: #16a34a; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">00</button>
                    <button onclick="selectRouletteBet(1)" class="roulette-bet-btn" data-type="1" style="padding: 6px 4px; background: #dc2626; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">1</button>
                    <button onclick="selectRouletteBet(2)" class="roulette-bet-btn" data-type="2" style="padding: 6px 4px; background: #1a1a1a; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">2</button>
                    <button onclick="selectRouletteBet(3)" class="roulette-bet-btn" data-type="3" style="padding: 6px 4px; background: #dc2626; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">3</button>
                    <button onclick="selectRouletteBet(4)" class="roulette-bet-btn" data-type="4" style="padding: 6px 4px; background: #1a1a1a; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;">4</button>
                </div>
                
                <div style="display: flex; gap: 4px; padding: 8px; background: rgba(30, 35, 45, 0.4); border-radius: 8px; overflow-x: auto; margin-bottom: 8px;">
                    <div id="rouletteHistory" style="display: flex; gap: 4px;"></div>
                </div>
                
                    <div style="flex: 1; background: rgba(30, 35, 45, 0.4); border-radius: 8px; padding: 8px; overflow-y: auto; max-height: 150px;">
                        <div id="rouletteBets" style="font-size: 0.85em;">
                            <div style="text-align: center; color: rgba(255,255,255,0.4); padding: 10px;">
                                История ставок появится здесь
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="ratingPage" style="display: none; height: calc(100vh - 60px); overflow-y: auto; padding: 15px; padding-bottom: 20px; background: #0f1419;">
            <h1 style="text-align: center; margin-bottom: 15px; font-size: 1.6em;">🏆 Рейтинг</h1>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="loadLeaderboard('balance')" id="ratingBalance" class="rating-tab" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                    💰 По балансу
                </button>
                <button onclick="loadLeaderboard('wins')" id="ratingWins" class="rating-tab" style="flex: 1; padding: 10px; background: rgba(30, 35, 45, 0.6); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                    🏆 По победам
                </button>
            </div>
            
            <div id="leaderboardList" style="display: flex; flex-direction: column; gap: 8px;">
                <div style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px;">
                    Загрузка рейтинга...
                </div>
            </div>
        </div>
        
        <div id="profilePage" style="display: none; height: calc(100vh - 60px); overflow-y: auto; padding: 15px; padding-bottom: 20px; background: #0f1419;">
            <h1 style="text-align: center; margin-bottom: 15px; font-size: 1.6em;">👤 Профиль</h1>
            
            <div class="profile-info">
                <div class="profile-avatar" id="profileAvatar">👤</div>
                <div class="profile-details">
                    <div class="profile-name" id="profileName">Игрок</div>
                    <div class="profile-stats">
                        <span class="stat-item">🎮 <span id="totalGames">0</span></span>
                        <span class="stat-item">🏆 <span id="totalWins">0</span></span>
                        <span class="stat-item">📈 <span id="winRate">0</span>%</span>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(30, 35, 45, 0.6); border-radius: 15px; padding: 15px; border: 1px solid rgba(59, 130, 246, 0.2); margin-top: 20px;">
                <div class="profile-stat-row">
                    <span>Всего ставок:</span>
                    <span id="totalBetsAmount">0 ⭐</span>
                </div>
                <div class="profile-stat-row">
                    <span>Всего выигрышей:</span>
                    <span id="totalWinsAmount">0 ⭐</span>
                </div>
                <div class="profile-stat-row">
                    <span>Прибыль/Убыток:</span>
                    <span id="profitLoss">0 ⭐</span>
                </div>
                <div class="profile-stat-row">
                    <span>Лучший множитель:</span>
                    <span id="bestMultiplier">0.00x</span>
                </div>
                <div class="profile-stat-row">
                    <span>Средний множитель:</span>
                    <span id="avgMultiplier">0.00x</span>
                </div>
            </div>
            
            <!-- Кнопка бонуса -->
            <button onclick="claimBonus()" id="bonusBtn" style="width: 100%; padding: 15px; margin-top: 15px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 1.1em; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);">
                🎁 Получить бонус 5000 ⭐
            </button>
            <div id="bonusTimer" style="text-align: center; margin-top: 10px; color: rgba(255,255,255,0.6); font-size: 0.9em; display: none;">
                Следующий бонус через: <span id="bonusTimeLeft"></span>
            </div>
            
            <!-- Админ панель -->
            <div id="adminPanel" style="display: none; margin-top: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
                <h3 style="color: #8b5cf6; margin-bottom: 10px;">👑 Админ панель</h3>
                
                <button onclick="toggleAdminUsersList()" style="width: 100%; padding: 10px; margin-bottom: 8px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                    📋 Показать всех игроков
                </button>
                
                <div id="adminUsersList" style="display: none; max-height: 200px; overflow-y: auto; margin-bottom: 8px; padding: 8px; background: rgba(30, 35, 45, 0.6); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3);">
                    <div style="text-align: center; color: rgba(255,255,255,0.4); padding: 10px;">Загрузка...</div>
                </div>
                
                <input type="text" id="adminTargetId" placeholder="ID игрока" style="width: 100%; padding: 10px; margin-bottom: 8px; border: 2px solid rgba(139, 92, 246, 0.4); border-radius: 8px; background: rgba(30, 35, 45, 0.6); color: white;">
                <input type="number" id="adminAmount" placeholder="Сумма" value="1000" style="width: 100%; padding: 10px; margin-bottom: 8px; border: 2px solid rgba(139, 92, 246, 0.4); border-radius: 8px; background: rgba(30, 35, 45, 0.6); color: white;">
                
                <div style="display: flex; gap: 8px;">
                    <button onclick="adminGiveCurrency()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                        ➕ Выдать
                    </button>
                    <button onclick="adminTakeCurrency()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                        ➖ Забрать
                    </button>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <button class="nav-btn active" id="navGames" onclick="switchTab('games')"><div class="nav-btn-icon">🎮</div><div>Игры</div></button><button class="nav-btn" id="navRating" onclick="switchTab('rating')"><div class="nav-btn-icon">🏆</div><div>Рейтинг</div></button><button class="nav-btn" id="navProfile" onclick="switchTab('profile')"><div class="nav-btn-icon">👤</div><div>Профиль</div></button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        // API URL - ваш домен Railway
        const API_URL = 'https://web-production-3f4d.up.railway.app';
        
        // WebSocket подключение
        const socket = io(API_URL);
        let serverGameActive = false;
        let serverMultiplier = 1.0;
        
        let balance = 0;
        let currentBet = 0;
        let multiplier = 1.0;
        let gameInterval = null;
        let crashPoint = 0;
        let gameStartTime = 0;
        let graphPoints = [];
        let cashedOutAt = 0;
        let gameHistory = [];
        let currentPlayers = [];
        let roundTimer = 10;
        let timerInterval = null;
        let countdownInterval = null;
        let isGameActive = false;
        let isWaitingForBets = false;
        let hasBet = false;
        let playerStats = {
            totalGames: 0,
            totalWins: 0,
            totalBetsAmount: 0,
            totalWinsAmount: 0,
            bestMultiplier: 0,
            multipliers: []
        };
        
        // Состояния игры
        const GAME_STATE = {
            WAITING: 'waiting',      // Ожидание первой ставки
            BETTING: 'betting',      // Прием ставок (10 сек)
            COUNTDOWN: 'countdown',  // Обратный отсчет (5 сек)
            PLAYING: 'playing',      // Игра идет
            CRASHED: 'crashed'       // Краш произошел
        };
        
        let gameState = GAME_STATE.WAITING;
        
        // Canvas setup
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            const gameArea = document.getElementById('gameArea');
            canvas.width = gameArea.offsetWidth;
            canvas.height = gameArea.offsetHeight;
        }
        
        // Инициализация
        tg.ready();
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        

        
        // Получение данных пользователя
        const userId = tg.initDataUnsafe?.user?.id || 'demo';
        
        // Загрузка баланса с сервера
        async function loadBalance() {
            try {
                const userName = tg.initDataUnsafe?.user?.first_name || 'Игрок';
                const response = await fetch(`${API_URL}/api/user/get`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, username: userName })
                });
                const data = await response.json();
                balance = data.balance;
                
                // Загружаем статистику
                playerStats = {
                    totalGames: data.total_games,
                    totalWins: data.total_wins,
                    totalBetsAmount: data.total_bets_amount,
                    totalWinsAmount: data.total_wins_amount,
                    bestMultiplier: data.best_multiplier,
                    multipliers: data.multipliers || []
                };
                
                updateBalance();
                updateProfileDisplay();
            } catch (error) {
                console.error('Error loading balance:', error);
                // Fallback к localStorage
                const saved = localStorage.getItem(`balance_${userId}`);
                balance = saved ? parseInt(saved) : 100;
                updateBalance();
            }
        }
        
        function updateBalance() {
            document.getElementById('balance').textContent = balance;
            const gamesBalance = document.getElementById('balanceGames');
            if (gamesBalance) gamesBalance.textContent = balance;
        }
        
        // Профиль игрока
        function loadPlayerStats() {
            // Данные загружаются вместе с балансом
            updateProfileDisplay();
        }
        
        async function savePlayerStats() {
            // Данные сохраняются на сервере автоматически
            updateProfileDisplay();
        }
        
        function updateProfileDisplay() {
            document.getElementById('totalGames').textContent = playerStats.totalGames;
            document.getElementById('totalWins').textContent = playerStats.totalWins;
            
            const winRate = playerStats.totalGames > 0 
                ? Math.round((playerStats.totalWins / playerStats.totalGames) * 100) 
                : 0;
            document.getElementById('winRate').textContent = winRate;
            
            document.getElementById('totalBetsAmount').textContent = playerStats.totalBetsAmount + ' ⭐';
            document.getElementById('totalWinsAmount').textContent = playerStats.totalWinsAmount + ' ⭐';
            
            const profitLoss = playerStats.totalWinsAmount - playerStats.totalBetsAmount;
            const profitLossEl = document.getElementById('profitLoss');
            profitLossEl.textContent = (profitLoss >= 0 ? '+' : '') + profitLoss + ' ⭐';
            profitLossEl.style.color = profitLoss >= 0 ? '#4CAF50' : '#f44336';
            
            document.getElementById('bestMultiplier').textContent = playerStats.bestMultiplier.toFixed(2) + 'x';
            
            const avgMultiplier = playerStats.multipliers.length > 0
                ? playerStats.multipliers.reduce((a, b) => a + b, 0) / playerStats.multipliers.length
                : 0;
            document.getElementById('avgMultiplier').textContent = avgMultiplier.toFixed(2) + 'x';
            
            // Обновляем имя игрока
            const userName = tg.initDataUnsafe?.user?.first_name || 'Игрок';
            document.getElementById('profileName').textContent = userName;
        }
        
        function toggleProfile() {
            const expanded = document.getElementById('profileExpanded');
            if (expanded.style.display === 'none') {
                expanded.style.display = 'block';
            } else {
                expanded.style.display = 'none';
            }
        }
        
        async function recordGameResult(won, betAmount, winAmount, multiplierUsed) {
            try {
                const response = await fetch(`${API_URL}/api/game/record_result`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        won: won,
                        bet_amount: betAmount,
                        win_amount: winAmount,
                        multiplier: multiplierUsed
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    playerStats.totalGames = data.stats.total_games;
                    playerStats.totalWins = data.stats.total_wins;
                    balance = data.stats.balance;
                    updateBalance();
                    savePlayerStats();
                }
            } catch (error) {
                console.error('Error recording game result:', error);
            }
        }
        

        
        async function startGame() {
            const betInput = document.getElementById('betInput');
            const bet = parseInt(betInput.value);
            
            if (bet < 10) {
                updateStatus('❌ Минимальная ставка: 10 ⭐');
                return;
            }
            
            if (bet > balance) {
                updateStatus('❌ Недостаточно средств!');
                return;
            }
            
            if (gameState === GAME_STATE.PLAYING || gameState === GAME_STATE.COUNTDOWN) {
                updateStatus('❌ Раунд уже начался! Дождитесь следующего.');
                return;
            }
            
            if (hasBet) {
                updateStatus('❌ Вы уже сделали ставку!');
                return;
            }
            
            // Делаем ставку на сервере
            try {
                const response = await fetch(`${API_URL}/api/game/place_bet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, bet_amount: bet })
                });
                const data = await response.json();
                
                if (!data.success) {
                    updateStatus('❌ ' + data.error);
                    return;
                }
                
                balance = data.balance;
                updateBalance();
            } catch (error) {
                console.error('Error placing bet:', error);
                balance -= bet;
                updateBalance();
            }
            
            currentBet = bet;
            cashedOutAt = 0;
            hasBet = true;
            
            // Скрываем клавиатуру
            document.getElementById('betInput').blur();
            
            document.getElementById('playBtn').disabled = true;
            document.getElementById('playBtn').textContent = '⏳ Ожидание...';
            document.getElementById('betInput').disabled = true;
            
            // Отправляем ставку на сервер через WebSocket
            const userName = tg.initDataUnsafe?.user?.first_name || 'Игрок';
            socket.emit('place_bet', {
                userId: userId,
                name: userName,
                bet: bet
            });
            
            // Добавляем себя в список сразу
            currentPlayers.push({
                name: userName,
                bet: bet,
                result: null,
                cashout: null
            });
            updatePlayersList();
            
            updateStatus(`✅ Ставка принята! Ожидайте начала игры...`);
        }
        
        function updateGame() {
            const elapsed = (Date.now() - gameStartTime) / 1000;
            
            // Экспоненциальный рост как в реальном краше
            multiplier = Math.pow(1.06, elapsed * 2);
            
            if (multiplier >= crashPoint) {
                endGame(false);
                return;
            }
            
            // Обновление множителя
            const multiplierEl = document.getElementById('multiplier');
            multiplierEl.textContent = multiplier.toFixed(2) + 'x';
            
            // Изменение цвета в зависимости от множителя
            if (multiplier < 2) {
                multiplierEl.style.color = '#3b82f6';
            } else if (multiplier < 5) {
                multiplierEl.style.color = '#22c55e';
            } else if (multiplier < 10) {
                multiplierEl.style.color = '#eab308';
            } else {
                multiplierEl.style.color = '#ef4444';
            }
            

            
            // Добавление точки в график
            graphPoints.push({
                x: elapsed,
                y: multiplier
            });
            
            // Отрисовка графика
            drawGraph();
            
            // Позиционирование ракеты
            updateRocketPosition();
        }
        
        function drawGraph() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (graphPoints.length < 2) return;
            
            // Рисуем красивую линию полета
            const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
            gradient.addColorStop(0.5, 'rgba(59, 130, 246, 0.5)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.2)');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = 'rgba(59, 130, 246, 0.5)';
            ctx.shadowBlur = 10;
            
            ctx.beginPath();
            
            const maxTime = Math.max(10, graphPoints[graphPoints.length - 1].x + 2);
            const gameArea = document.getElementById('gameArea');
            const maxHeight = gameArea.offsetHeight - 100;
            
            graphPoints.forEach((point, index) => {
                const x = (point.x / maxTime) * canvas.width;
                
                // Ограничиваем высоту графика
                let heightPercent = (point.y - 1) * 40;
                if (heightPercent > maxHeight) {
                    heightPercent = maxHeight;
                }
                
                const y = canvas.height - 25 - heightPercent;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        
        function updateRocketPosition() {
            const rocket = document.getElementById('rocket');
            
            if (graphPoints.length === 0) return;
            
            const gameArea = document.getElementById('gameArea');
            const maxHeight = gameArea.offsetHeight - 100;
            
            // Ракета поднимается по стенке вверх
            let heightPercent = (multiplier - 1) * 40;
            
            // Ограничиваем высоту, чтобы не выходила за рамки
            if (heightPercent > maxHeight) {
                heightPercent = maxHeight;
            }
            
            rocket.style.bottom = (25 + heightPercent) + 'px';
            
            // Небольшое покачивание для реалистичности
            const wobble = Math.sin(Date.now() / 200) * 2;
            rocket.style.transform = `translateX(-50%) rotate(${wobble}deg)`;
        }
        
        async function cashout() {
            if (!hasBet || cashedOutAt > 0 || !serverGameActive) return;
            
            const winAmount = Math.floor(currentBet * multiplier);
            cashedOutAt = multiplier;
            
            // Отправляем на сервер
            socket.emit('cashout', { userId: userId, multiplier: multiplier });
            
            // Начисляем выигрыш
            try {
                const response = await fetch(`${API_URL}/api/user/update_balance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, amount: winAmount })
                });
                const data = await response.json();
                balance = data.balance;
                updateBalance();
            } catch (error) {
                console.error('Error updating balance:', error);
                balance += winAmount;
                updateBalance();
            }
            
            recordGameResult(true, currentBet, winAmount, multiplier);
            
            updateStatus(`✅ Выигрыш: ${winAmount} ⭐ (${multiplier.toFixed(2)}x) - Ракета продолжает лететь...`);
            document.getElementById('playBtn').disabled = true;
            document.getElementById('playBtn').textContent = '✅ Выигрыш забран';
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }
        
        function endGame(crashed) {
            clearInterval(gameInterval);
            isGameActive = false;
            
            const rocket = document.getElementById('rocket');
            const multiplierEl = document.getElementById('multiplier');
            
            multiplierEl.classList.remove('growing');
            
            // Анимация краша
            rocket.classList.add('crashed');
            
            const crashText = document.getElementById('crashText');
            crashText.classList.add('show');
            crashText.textContent = `💥 ${crashPoint.toFixed(2)}x`;
            
            // Добавляем в историю
            addToHistory(crashPoint);
            
            // Обновляем результаты игроков, которые не забрали
            if (hasBet && cashedOutAt === 0) {
                const userName = tg.initDataUnsafe?.user?.first_name || 'Игрок';
                updatePlayerResult(userName, 0, false);
                
                // Записываем проигрыш в статистику
                recordGameResult(false, currentBet, 0, 0);
            }
            
            // Обновление статуса в зависимости от того, забрал ли игрок
            if (hasBet) {
                if (cashedOutAt > 0) {
                    const winAmount = Math.floor(currentBet * cashedOutAt);
                    updateStatus(`✅ Вы забрали на ${cashedOutAt.toFixed(2)}x (${winAmount} ⭐) | Краш: ${crashPoint.toFixed(2)}x`);
                } else {
                    updateStatus(`💥 Краш на ${crashPoint.toFixed(2)}x! Вы проиграли ${currentBet} ⭐`);
                }
            } else {
                updateStatus(`💥 Краш на ${crashPoint.toFixed(2)}x!`);
            }
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
            
            setTimeout(() => {
                rocket.classList.remove('crashed');
                rocket.style.bottom = '25px';
                rocket.style.transform = 'translateX(-50%)';
                // Сбрасываем анимацию
                void rocket.offsetWidth; // Trigger reflow
                
                document.getElementById('crashText').classList.remove('show');
                multiplierEl.textContent = '1.00x';
                multiplierEl.style.color = '#3b82f6';
                multiplierEl.style.fontSize = '4.5em';
                
                document.getElementById('playBtn').disabled = false;
                document.getElementById('playBtn').textContent = '🚀 Сделать ставку';
                document.getElementById('playBtn').onclick = startGame;
                document.getElementById('betInput').disabled = false;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                graphPoints = [];
                multiplier = 1.0;
                cashedOutAt = 0;
                hasBet = false;
                currentPlayers = [];
                updatePlayersList();
                
                // Сброс состояния игры
                gameState = GAME_STATE.WAITING;
                updateStatus('💰 Ожидание ставок...');
            }, 3000);
        }
        
        function generateCrashPoint() {
            // Экономика казино: больше низких множителей, меньше высоких
            const rand = Math.random();
            
            // 60% шанс: 1.00x - 2.00x (казино в плюсе)
            if (rand < 0.60) {
                return 1.0 + Math.random() * 1.0;
            }
            // 25% шанс: 2.00x - 4.00x (небольшой выигрыш)
            else if (rand < 0.85) {
                return 2.0 + Math.random() * 2.0;
            }
            // 10% шанс: 4.00x - 7.00x (средний выигрыш)
            else if (rand < 0.95) {
                return 4.0 + Math.random() * 3.0;
            }
            // 4% шанс: 7.00x - 15.00x (большой выигрыш)
            else if (rand < 0.99) {
                return 7.0 + Math.random() * 8.0;
            }
            // 1% шанс: 15.00x - 50.00x (джекпот)
            else {
                return 15.0 + Math.random() * 35.0;
            }
        }
        
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
        
        function topUp() {
            // Открываем бота для пополнения
            tg.openTelegramLink(`https://t.me/${tg.initDataUnsafe?.bot?.username || 'your_bot'}?start=topup`);
        }
        
        // История игр
        async function loadHistory() {
            try {
                const response = await fetch(`${API_URL}/api/game/history`);
                const data = await response.json();
                gameHistory = data.history || [];
                updateHistoryBar();
            } catch (error) {
                console.error('Error loading history:', error);
                // Fallback: показываем начальную историю
                gameHistory = [2.45, 1.23, 5.67, 3.21, 1.89, 8.45, 2.10, 4.56];
                updateHistoryBar();
            }
        }
        
        async function addToHistory(crashValue) {
            // НЕ отправляем на сервер - сервер сам сохраняет
            // Только обновляем локально если еще нет
            if (!gameHistory.includes(crashValue)) {
                gameHistory.unshift(crashValue);
                if (gameHistory.length > 8) {
                    gameHistory = gameHistory.slice(0, 8);
                }
                updateHistoryBar();
            }
        }
        
        function updateHistoryBar() {
            const historyBar = document.getElementById('historyBar');
            if (!historyBar) return;
            
            historyBar.innerHTML = '';
            
            // Показываем последние 8 игр
            const recentGames = gameHistory.slice(0, 8);
            
            recentGames.forEach(value => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                if (value < 2) {
                    item.classList.add('low');
                } else if (value < 5) {
                    item.classList.add('medium');
                } else {
                    item.classList.add('high');
                }
                
                item.textContent = value.toFixed(2) + 'x';
                historyBar.appendChild(item);
            });
        }
        
        // Игроки
        function addPlayer(name, bet) {
            currentPlayers.push({
                name: name,
                bet: bet,
                result: null,
                cashout: null
            });
            updatePlayersList();
        }
        
        function updatePlayerResult(name, cashout, win) {
            const player = currentPlayers.find(p => p.name === name);
            if (player) {
                player.cashout = cashout;
                player.result = win;
                updatePlayersList();
            }
        }
        
        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            
            if (currentPlayers.length === 0) {
                playersList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); font-size: 0.9em;">Ставки игроков появятся здесь</div>';
                return;
            }
            
            playersList.innerHTML = '';
            
            currentPlayers.forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'player-name';
                nameSpan.textContent = player.name;
                
                const betSpan = document.createElement('span');
                betSpan.className = 'player-bet';
                betSpan.textContent = player.bet + ' ⭐';
                
                const resultSpan = document.createElement('span');
                resultSpan.className = 'player-result';
                
                if (player.result === null) {
                    resultSpan.textContent = '⏳';
                } else if (player.result) {
                    resultSpan.classList.add('win');
                    const winAmount = Math.floor(player.bet * player.cashout);
                    resultSpan.textContent = `+${winAmount} (${player.cashout.toFixed(2)}x)`;
                } else {
                    resultSpan.classList.add('loss');
                    resultSpan.textContent = `-${player.bet}`;
                }
                
                item.appendChild(nameSpan);
                item.appendChild(betSpan);
                item.appendChild(resultSpan);
                
                playersList.appendChild(item);
            });
        }
        
        // Таймер приема ставок - ОТКЛЮЧЕН, управляется сервером
        function startBettingTimer() {
            // Ничего не делаем - сервер управляет таймером
        }
        
        // Обратный отсчет - ОТКЛЮЧЕН, управляется сервером
        function startCountdown() {
            // Ничего не делаем - сервер управляет
        }
        
        // Запуск игры - ОТКЛЮЧЕН, управляется сервером
        function startRocketGame() {
            // Ничего не делаем - сервер управляет
        }
        
        // Навигация
        function switchTab(tab) {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            const gamesPage = document.getElementById('gamesPage');
            const crashPage = document.getElementById('crashPage');
            const casesPage = document.getElementById('casesPage');
            const upgradePage = document.getElementById('upgradePage');
            const ratingPage = document.getElementById('ratingPage');
            const profilePage = document.getElementById('profilePage');
            
            gamesPage.style.display = 'none';
            crashPage.style.display = 'none';
            casesPage.style.display = 'none';
            upgradePage.style.display = 'none';
            ratingPage.style.display = 'none';
            profilePage.style.display = 'none';
            
            if (tab === 'games') {
                document.getElementById('navGames').classList.add('active');
                gamesPage.style.display = 'block';
                loadWinsFeed();
            } else if (tab === 'rating') {
                document.getElementById('navRating').classList.add('active');
                ratingPage.style.display = 'block';
                loadLeaderboard('balance');
            } else if (tab === 'profile') {
                document.getElementById('navProfile').classList.add('active');
                profilePage.style.display = 'block';
                loadPlayerStats();
            }
        }
        
        function openGame(game) {
            const gamesPage = document.getElementById('gamesPage');
            const crashPage = document.getElementById('crashPage');
            const casesPage = document.getElementById('casesPage');
            const upgradePage = document.getElementById('upgradePage');
            
            gamesPage.style.display = 'none';
            
            if (game === 'crash') {
                crashPage.style.display = 'flex';
            } else if (game === 'plinko') {
                casesPage.style.display = 'block';
            } else if (game === 'roulette') {
                upgradePage.style.display = 'block';
            }
        }
        
        function backToGames() {
            switchTab('games');
        }
        
        function toggleRouletteBets() {
            const panel = document.getElementById('rouletteBetsPanel');
            const btn = document.getElementById('rouletteToggle');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.textContent = '▼ Панель ставок';
            } else {
                panel.style.display = 'none';
                btn.textContent = '▶ Панель ставок';
            }
        }
        
        // Получение онлайн пользователей
        async function updateOnlineUsers() {
            try {
                const response = await fetch(`${API_URL}/api/online`);
                const data = await response.json();
                document.getElementById('onlineUsers').textContent = data.online;
                const gamesOnline = document.getElementById('onlineUsersGames');
                if (gamesOnline) gamesOnline.textContent = data.online;
            } catch (error) {
                console.error('Error getting online users:', error);
                const baseUsers = 15;
                const randomUsers = Math.floor(Math.random() * 10);
                const online = baseUsers + randomUsers;
                document.getElementById('onlineUsers').textContent = online;
                const gamesOnline = document.getElementById('onlineUsersGames');
                if (gamesOnline) gamesOnline.textContent = online;
            }
        }
        
        // Plinko - множители от краев к центру (x10 в центре)
        let isDroppingBall = false;
        let currentPlinkoMode = 'low';
        
        // Режимы Plinko с разными множителями
        const plinkoModes = {
            low: {
                name: 'Низкий',
                multipliers: [5, 3, 2, 1.5, 1.2, 1, 0.8, 1, 1.2, 1.5, 2, 3, 5],
                colors: ['#7c3aed', '#8b5cf6', '#a78bfa', '#6366f1', '#3b82f6', '#2563eb', '#1e40af', '#2563eb', '#3b82f6', '#6366f1', '#a78bfa', '#8b5cf6', '#7c3aed']
            },
            medium: {
                multipliers: [10, 5, 3, 2, 1.5, 1, 0.5, 1, 1.5, 2, 3, 5, 10],
                colors: ['#6d28d9', '#7c3aed', '#8b5cf6', '#a78bfa', '#6366f1', '#3b82f6', '#1e40af', '#3b82f6', '#6366f1', '#a78bfa', '#8b5cf6', '#7c3aed', '#6d28d9']
            },
            high: {
                multipliers: [20, 10, 5, 3, 2, 1, 0.3, 1, 2, 3, 5, 10, 20],
                colors: ['#dc2626', '#ef4444', '#f97316', '#fb923c', '#fbbf24', '#3b82f6', '#1e3a8a', '#3b82f6', '#fbbf24', '#fb923c', '#f97316', '#ef4444', '#dc2626']
            }
        };
        
        // Текущие множители и цвета (по умолчанию - низкий режим)
        let plinkoMultipliers = plinkoModes.low.multipliers;
        let plinkoColors = plinkoModes.low.colors;
        
        function selectPlinkoMode(mode) {
            currentPlinkoMode = mode;
            plinkoMultipliers = plinkoModes[mode].multipliers;
            plinkoColors = plinkoModes[mode].colors;
            
            // Обновляем UI кнопок
            document.querySelectorAll('.plinko-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'rgba(30, 35, 45, 0.6)';
                btn.style.border = '1px solid rgba(59, 130, 246, 0.2)';
                btn.style.color = 'rgba(255,255,255,0.6)';
            });
            
            const activeBtn = document.getElementById('plinkoMode' + mode.charAt(0).toUpperCase() + mode.slice(1));
            activeBtn.classList.add('active');
            activeBtn.style.background = 'rgba(59, 130, 246, 0.2)';
            activeBtn.style.border = '1px solid rgba(59, 130, 246, 0.4)';
            activeBtn.style.color = 'white';
            
            // Перерисовываем доску
            initPlinko();
        }
        
        function initPlinko() {
            const canvas = document.getElementById('plinkoCanvas');
            const ctx = canvas.getContext('2d');
            
            // Рисуем доску
            drawPlinkoBoard(ctx, canvas.width, canvas.height);
        }
        
        function drawPlinkoBoard(ctx, width, height) {
            ctx.clearRect(0, 0, width, height);
            
            // Рисуем колышки (13 слотов = 12 рядов)
            const rows = 12;
            const cols = 13;
            const pegRadius = 2.5;
            const startY = 35;
            const spacing = 20;
            
            ctx.fillStyle = '#3b82f6';
            for (let row = 0; row < rows; row++) {
                const pegsInRow = row + 3;
                const startX = (width - (pegsInRow - 1) * spacing) / 2;
                
                for (let col = 0; col < pegsInRow; col++) {
                    const x = startX + col * spacing;
                    const y = startY + row * spacing;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, pegRadius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Рисуем слоты внизу с боковыми стенками
            const slotWidth = width / plinkoMultipliers.length;
            const slotY = height - 35;
            const slotHeight = 30;
            const wallHeight = 15;
            
            plinkoMultipliers.forEach((multi, index) => {
                const x = index * slotWidth;
                
                // Рисуем дно слота
                ctx.fillStyle = plinkoColors[index];
                ctx.fillRect(x + 1, slotY, slotWidth - 2, slotHeight);
                
                // Рисуем левую стенку для всех слотов
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(x, slotY - wallHeight, 2, wallHeight + slotHeight);
                
                // Рисуем правую стенку последнего слота
                if (index === plinkoMultipliers.length - 1) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(x + slotWidth - 2, slotY - wallHeight, 2, wallHeight + slotHeight);
                }
                
                // Текст множителя
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`x${multi}`, x + slotWidth / 2, slotY + 19);
            });
        }
        
        async function dropBall() {
            if (isDroppingBall) return;
            
            const betAmount = parseInt(document.getElementById('plinkoBetInput').value);
            
            if (betAmount < 10) {
                updateStatus('❌ Минимальная ставка: 10 ⭐');
                return;
            }
            
            if (betAmount > balance) {
                updateStatus('❌ Недостаточно средств!');
                return;
            }
            
            isDroppingBall = true;
            document.getElementById('plinkoBtn').disabled = true;
            document.getElementById('plinkoResult').style.display = 'none';
            
            // Блокируем кнопки режимов
            document.getElementById('plinkoModeLow').disabled = true;
            document.getElementById('plinkoModeMedium').disabled = true;
            document.getElementById('plinkoModeHigh').disabled = true;
            
            // Списываем ставку
            try {
                const response = await fetch(`${API_URL}/api/game/place_bet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, bet_amount: betAmount })
                });
                const data = await response.json();
                
                if (!data.success) {
                    updateStatus('❌ ' + data.error);
                    isDroppingBall = false;
                    document.getElementById('plinkoBtn').disabled = false;
                    document.getElementById('plinkoModeLow').disabled = false;
                    document.getElementById('plinkoModeMedium').disabled = false;
                    document.getElementById('plinkoModeHigh').disabled = false;
                    return;
                }
                
                balance = data.balance;
                updateBalance();
            } catch (error) {
                console.error('Error placing bet:', error);
                balance -= betAmount;
                updateBalance();
            }
            
            // Анимация падения шарика
            const canvas = document.getElementById('plinkoCanvas');
            const ctx = canvas.getContext('2d');
            const slotIndex = await animateBall(ctx, canvas.width, canvas.height);
            
            // Показываем результат
            const multiplier = plinkoMultipliers[slotIndex];
            const winAmount = Math.floor(betAmount * multiplier);
            
            showPlinkoResult(multiplier, winAmount, betAmount);
            
            // Начисляем выигрыш
            if (winAmount > 0) {
                try {
                    const response = await fetch(`${API_URL}/api/user/update_balance`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId, amount: winAmount })
                    });
                    const data = await response.json();
                    balance = data.balance;
                    updateBalance();
                } catch (error) {
                    console.error('Error updating balance:', error);
                    balance += winAmount;
                    updateBalance();
                }
            }
            
            isDroppingBall = false;
            document.getElementById('plinkoBtn').disabled = false;
            document.getElementById('plinkoModeLow').disabled = false;
            document.getElementById('plinkoModeMedium').disabled = false;
            document.getElementById('plinkoModeHigh').disabled = false;
        }
        
        function animateBall(ctx, width, height) {
            return new Promise((resolve) => {
                const ball = {
                    x: width / 2,
                    y: 20,
                    radius: 6,
                    vx: (Math.random() - 0.5) * 2,
                    vy: 0,
                    gravity: 0.5,
                    bounce: 0.7,
                    friction: 0.98
                };
                
                const rows = 12;
                const spacing = 20;
                const startY = 35;
                const pegRadius = 2.5;
                
                // Создаем массив колышков
                const pegs = [];
                for (let row = 0; row < rows; row++) {
                    const pegsInRow = row + 3;
                    const startX = (width - (pegsInRow - 1) * spacing) / 2;
                    
                    for (let col = 0; col < pegsInRow; col++) {
                        pegs.push({
                            x: startX + col * spacing,
                            y: startY + row * spacing
                        });
                    }
                }
                
                let lastCollisionTime = 0;
                
                function animate() {
                    drawPlinkoBoard(ctx, width, height);
                    
                    // Применяем гравитацию
                    ball.vy += ball.gravity;
                    
                    // Применяем трение к горизонтальной скорости
                    ball.vx *= ball.friction;
                    
                    // Обновляем позицию
                    ball.x += ball.vx;
                    ball.y += ball.vy;
                    
                    const currentTime = Date.now();
                    
                    // Проверка столкновений с колышками
                    pegs.forEach(peg => {
                        const dx = ball.x - peg.x;
                        const dy = ball.y - peg.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < ball.radius + pegRadius && currentTime - lastCollisionTime > 50) {
                            lastCollisionTime = currentTime;
                            
                            // Нормализуем вектор столкновения
                            const angle = Math.atan2(dy, dx);
                            
                            // Отталкиваем шарик от колышка
                            const overlap = ball.radius + pegRadius - distance;
                            ball.x += Math.cos(angle) * overlap;
                            ball.y += Math.sin(angle) * overlap;
                            
                            // Отражаем скорость с учетом угла
                            const speed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy);
                            
                            // Добавляем случайность для реалистичности
                            const randomFactor = (Math.random() - 0.5) * 0.5;
                            ball.vx = (Math.cos(angle) * speed * ball.bounce) + randomFactor;
                            ball.vy = Math.sin(angle) * speed * ball.bounce;
                            
                            // Минимальная горизонтальная скорость
                            if (Math.abs(ball.vx) < 0.5) {
                                ball.vx = (Math.random() - 0.5) * 2;
                            }
                        }
                    });
                    
                    // Ограничения по бокам с отскоком
                    if (ball.x < ball.radius) {
                        ball.x = ball.radius;
                        ball.vx = Math.abs(ball.vx) * ball.bounce;
                    }
                    if (ball.x > width - ball.radius) {
                        ball.x = width - ball.radius;
                        ball.vx = -Math.abs(ball.vx) * ball.bounce;
                    }
                    
                    // Рисуем шарик с градиентом
                    const gradient = ctx.createRadialGradient(ball.x - 2, ball.y - 2, 0, ball.x, ball.y, ball.radius);
                    gradient.addColorStop(0, '#ffffff');
                    gradient.addColorStop(1, '#3b82f6');
                    
                    ctx.shadowColor = 'rgba(59, 130, 246, 0.6)';
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // Проверка достижения зоны слотов
                    const slotZoneY = height - 50;
                    if (ball.y >= slotZoneY - ball.radius) {
                        ball.y = slotZoneY - ball.radius;
                        
                        // Проверка столкновения со стенками слотов
                        const slotWidth = width / plinkoMultipliers.length;
                        const currentSlot = Math.floor(ball.x / slotWidth);
                        const slotX = currentSlot * slotWidth;
                        
                        // Левая стенка слота
                        if (ball.x - ball.radius < slotX + 2 && ball.vx < 0) {
                            ball.x = slotX + 2 + ball.radius;
                            ball.vx = Math.abs(ball.vx) * 0.3; // Отскок от стенки
                        }
                        
                        // Правая стенка слота
                        if (ball.x + ball.radius > slotX + slotWidth - 2 && ball.vx > 0) {
                            ball.x = slotX + slotWidth - 2 - ball.radius;
                            ball.vx = -Math.abs(ball.vx) * 0.3; // Отскок от стенки
                        }
                        
                        // Шарик катится по дну слота
                        ball.vy = 0;
                        ball.vx *= 0.92; // Замедление при качении
                        
                        // Если скорость очень маленькая, останавливаемся
                        if (Math.abs(ball.vx) < 0.2) {
                            const slotIndex = Math.max(0, Math.min(plinkoMultipliers.length - 1, Math.floor(ball.x / slotWidth)));
                            
                            // Центрируем шарик в слоте
                            const targetX = slotX + slotWidth / 2;
                            let centerFrames = 15;
                            
                            function centerAnimation() {
                                drawPlinkoBoard(ctx, width, height);
                                
                                // Плавно двигаем к центру
                                ball.x += (targetX - ball.x) * 0.2;
                                
                                ctx.shadowColor = 'rgba(59, 130, 246, 0.6)';
                                ctx.shadowBlur = 15;
                                ctx.fillStyle = gradient;
                                ctx.beginPath();
                                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                                ctx.fill();
                                ctx.shadowBlur = 0;
                                
                                centerFrames--;
                                if (centerFrames > 0) {
                                    requestAnimationFrame(centerAnimation);
                                } else {
                                    resolve(slotIndex);
                                }
                            }
                            centerAnimation();
                            return;
                        }
                    }
                    
                    requestAnimationFrame(animate);
                }
                
                animate();
            });
        }
        
        function showPlinkoResult(multiplier, winAmount, betAmount) {
            const result = document.getElementById('plinkoResult');
            const title = document.getElementById('plinkoResultTitle');
            const amount = document.getElementById('plinkoResultAmount');
            
            result.style.display = 'block';
            
            if (winAmount > betAmount) {
                result.className = 'plinko-result win';
                title.textContent = '🎉 Победа!';
                amount.textContent = `+${winAmount - betAmount} ⭐ (x${multiplier})`;
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else if (winAmount === betAmount) {
                result.className = 'plinko-result';
                title.textContent = '😐 Возврат';
                amount.textContent = `x${multiplier} - ставка возвращена`;
            } else {
                result.className = 'plinko-result lose';
                title.textContent = '😢 Проигрыш';
                amount.textContent = `x${multiplier} - потеря ${betAmount - winAmount} ⭐`;
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        const doubleSegments = [
            // x2 (черный) - 50% (20 сегментов из 40)
            ...Array(20).fill({ multi: 2, color: '#2c2c2c' }),
            // x3 (желтый) - 33% (13 сегментов)
            ...Array(13).fill({ multi: 3, color: '#FFC107' }),
            // x5 (красный) - 15% (6 сегментов)
            ...Array(6).fill({ multi: 5, color: '#f44336' }),
            // x50 (зеленый) - 2% (1 сегмент)
            { multi: 50, color: '#4CAF50' }
        ];
        
        function selectDouble(multi) {
            selectedDoubleMulti = multi;
            
            document.querySelectorAll('.double-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.double-btn').classList.add('selected');
        }
        
        function generateDoubleWheel() {
            const wheel = document.getElementById('doubleWheel');
            wheel.innerHTML = '';
            
            // Перемешиваем сегменты для случайного распределения
            const shuffled = [...doubleSegments].sort(() => Math.random() - 0.5);
            
            shuffled.forEach((segment, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'double-segment';
                segmentDiv.style.background = segment.color;
                segmentDiv.style.transform = `rotate(${(360 / shuffled.length) * index}deg)`;
                segmentDiv.innerHTML = `<span class="double-segment-text">x${segment.multi}</span>`;
                wheel.appendChild(segmentDiv);
            });
        }
        
        async function startDouble() {
            if (isSpinningDouble) return;
            
            const betAmount = parseInt(document.getElementById('doubleBetInput').value);
            
            if (betAmount < 10) {
                updateStatus('❌ Минимальная ставка: 10 ⭐');
                return;
            }
            
            if (betAmount > balance) {
                updateStatus('❌ Недостаточно средств!');
                return;
            }
            
            isSpinningDouble = true;
            document.getElementById('doubleBtn').disabled = true;
            document.getElementById('doubleResult').style.display = 'none';
            
            // Списываем ставку
            try {
                const response = await fetch(`${API_URL}/api/game/place_bet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, bet_amount: betAmount })
                });
                const data = await response.json();
                
                if (!data.success) {
                    updateStatus('❌ ' + data.error);
                    isSpinningDouble = false;
                    document.getElementById('doubleBtn').disabled = false;
                    return;
                }
                
                balance = data.balance;
                updateBalance();
            } catch (error) {
                console.error('Error placing bet:', error);
                balance -= betAmount;
                updateBalance();
            }
            
            // Определяем результат
            const random = Math.random() * 100;
            let resultMulti;
            
            if (random < 50) {
                resultMulti = 2;
            } else if (random < 83) {
                resultMulti = 3;
            } else if (random < 98) {
                resultMulti = 5;
            } else {
                resultMulti = 50;
            }
            
            const won = resultMulti === selectedDoubleMulti;
            
            // Крутим колесо
            spinDoubleWheel(resultMulti, won, betAmount);
        }
        
        function spinDoubleWheel(resultMulti, won, betAmount) {
            const wheel = document.getElementById('doubleWheel');
            
            // Находим индекс сегмента с нужным множителем
            const targetIndex = doubleSegments.findIndex(s => s.multi === resultMulti);
            const segmentAngle = 360 / doubleSegments.length;
            const targetAngle = targetIndex * segmentAngle + segmentAngle / 2;
            
            const spins = 5;
            const totalRotation = 360 * spins - targetAngle;
            
            wheel.style.transform = `rotate(${totalRotation}deg)`;
            
            setTimeout(async () => {
                showDoubleResult(resultMulti, won, betAmount);
                
                if (won) {
                    const winAmount = betAmount * resultMulti;
                    
                    try {
                        const response = await fetch(`${API_URL}/api/user/update_balance`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: userId, amount: winAmount })
                        });
                        const data = await response.json();
                        balance = data.balance;
                        updateBalance();
                    } catch (error) {
                        console.error('Error updating balance:', error);
                        balance += winAmount;
                        updateBalance();
                    }
                }
                
                isSpinningDouble = false;
                document.getElementById('doubleBtn').disabled = false;
                
                setTimeout(() => {
                    wheel.style.transition = 'none';
                    wheel.style.transform = 'rotate(0deg)';
                    setTimeout(() => {
                        wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                    }, 50);
                }, 2000);
            }, 4000);
        }
        
        function showDoubleResult(resultMulti, won, betAmount) {
            const result = document.getElementById('doubleResult');
            const title = document.getElementById('doubleResultTitle');
            const amount = document.getElementById('doubleResultAmount');
            
            result.style.display = 'block';
            
            if (won) {
                const winAmount = betAmount * resultMulti;
                result.className = 'double-result win';
                title.textContent = '🎉 Победа!';
                amount.textContent = `+${winAmount} ⭐ (x${resultMulti})`;
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else {
                result.className = 'double-result lose';
                title.textContent = '😢 Проигрыш';
                amount.textContent = `Выпало x${resultMulti}, вы ставили на x${selectedDoubleMulti}`;
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        // Stock Market
        let stockPrice = 100;
        let stockStartPrice = 100;
        let stockHistory = [100];
        let stockTimer = 15;
        let stockInterval = null;
        let stockTimerInterval = null;
        let currentTrade = null;
        let stockGameActive = false;
        let stockPercentage = 0;
        
        function initStockMarket() {
            const canvas = document.getElementById('stockCanvas');
            if (!canvas) return;
            
            stockPrice = 100;
            stockHistory = [];
            // Начальная история
            for (let i = 0; i < 10; i++) {
                stockHistory.push(100);
            }
            stockPercentage = 0;
            stockGameActive = false;
            
            document.getElementById('stockTimer').textContent = 'Ожидание...';
            document.getElementById('stockUpBtn').disabled = false;
            document.getElementById('stockDownBtn').disabled = false;
            document.getElementById('stockPrice').textContent = '0 ⭐';
            
            const ctx = canvas.getContext('2d');
            drawStockChart(ctx, canvas.width, canvas.height);
        }
        
        function startStockRound() {
            stockTimer = 15;
            stockPrice = 100;
            stockStartPrice = 100;
            stockHistory = [];
            // Заполняем начальную историю
            for (let i = 0; i < 10; i++) {
                stockHistory.push(100);
            }
            stockPercentage = 0;
            stockGameActive = true;
            
            document.getElementById('stockUpBtn').disabled = true;
            document.getElementById('stockDownBtn').disabled = true;
            document.getElementById('stockResult').style.display = 'none';
            
            updateStockDisplay();
            
            // Таймер раунда
            stockTimerInterval = setInterval(() => {
                stockTimer--;
                document.getElementById('stockTimer').textContent = stockTimer + 's';
                
                if (stockTimer <= 0) {
                    endStockRound();
                }
            }, 1000);
            
            // Обновление цены (медленнее)
            stockInterval = setInterval(() => {
                updateStockPrice();
            }, 300);
        }
        
        function updateStockPrice() {
            // Плавное изменение цены с трендом
            const trend = (Math.random() - 0.5) * 3;
            stockPrice += trend;
            
            // Ограничиваем от 0 до 200 (центр = 100)
            stockPrice = Math.max(10, Math.min(190, stockPrice));
            
            // Вычисляем процент от центра (100)
            stockPercentage = stockPrice - 100;
            
            stockHistory.push(stockPrice);
            if (stockHistory.length > 50) {
                stockHistory.shift();
            }
            
            updateStockDisplay();
            updateTradeStatus();
        }
        
        function updateStockDisplay() {
            // Показываем текущий выигрыш/проигрыш в реальном времени
            if (currentTrade && stockGameActive) {
                const percentage = stockPercentage;
                let currentAmount = currentTrade.amount;
                
                // Если ставка совпадает с направлением - прибавляем
                if ((currentTrade.direction === 'up' && percentage > 0) || 
                    (currentTrade.direction === 'down' && percentage < 0)) {
                    // Выигрыш растет
                    const multiplier = 1 + (Math.abs(percentage) / 100);
                    currentAmount = Math.floor(currentTrade.amount * multiplier);
                    const profit = currentAmount - currentTrade.amount;
                    document.getElementById('stockPrice').innerHTML = `<span style="color: #22c55e">+${profit} ⭐</span>`;
                } else {
                    // Проигрыш растет
                    const lossPercent = Math.abs(percentage) / 100;
                    currentAmount = Math.floor(currentTrade.amount * (1 - lossPercent));
                    const loss = currentTrade.amount - currentAmount;
                    document.getElementById('stockPrice').innerHTML = `<span style="color: #ef4444">-${loss} ⭐</span>`;
                }
            } else {
                document.getElementById('stockPrice').textContent = '0 ⭐';
            }
            
            const canvas = document.getElementById('stockCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            drawStockChart(ctx, canvas.width, canvas.height);
        }
        
        function drawStockChart(ctx, width, height) {
            ctx.clearRect(0, 0, width, height);
            
            // Рисуем центральную линию (100 = 0%)
            const centerY = height / 2;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            if (stockHistory.length < 2) {
                // Если нет истории, рисуем начальную точку
                ctx.fillStyle = '#3b82f6';
                ctx.beginPath();
                ctx.arc(width / 2, centerY, 5, 0, Math.PI * 2);
                ctx.fill();
                return;
            }
            
            // Рисуем график (от 0 до 200, центр = 100)
            const currentColor = stockPrice >= 100 ? '#22c55e' : '#ef4444';
            
            // Градиент для линии
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, currentColor);
            gradient.addColorStop(1, currentColor + '80');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = currentColor;
            ctx.shadowBlur = 15;
            
            ctx.beginPath();
            stockHistory.forEach((price, index) => {
                const x = (index / Math.max(stockHistory.length - 1, 1)) * width;
                // Масштабируем от 0-200 к 0-height (инвертируем Y)
                const y = height - ((price / 200) * height);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            // Рисуем точку на конце линии
            if (stockHistory.length > 0) {
                const lastPrice = stockHistory[stockHistory.length - 1];
                const lastX = width;
                const lastY = height - ((lastPrice / 200) * height);
                
                ctx.fillStyle = currentColor;
                ctx.shadowColor = currentColor;
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(lastX, lastY, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }
        
        
        // Кейсы (старый код, можно удалить)
        const caseTypes = {
            bronze: {
                name: 'Бронзовый',
                price: 50,
                icon: '📦',
                rewards: [
                    { amount: 10, type: 'stars', rarity: 'common', chance: 35 },
                    { amount: 25, type: 'stars', rarity: 'common', chance: 25 },
                    { amount: 50, type: 'stars', rarity: 'rare', chance: 15 },
                    { amount: 75, type: 'stars', rarity: 'rare', chance: 10 },
                    { name: 'Бронзовая Звезда', type: 'nft', icon: '⭐', rarity: 'rare', chance: 10 },
                    { amount: 100, type: 'stars', rarity: 'epic', chance: 5 }
                ]
            },
            silver: {
                name: 'Серебряный',
                price: 100,
                icon: '🎁',
                rewards: [
                    { amount: 50, type: 'stars', rarity: 'common', chance: 30 },
                    { amount: 100, type: 'stars', rarity: 'rare', chance: 25 },
                    { name: 'Серебряный Кристалл', type: 'nft', icon: '💎', rarity: 'rare', chance: 15 },
                    { amount: 150, type: 'stars', rarity: 'rare', chance: 15 },
                    { amount: 200, type: 'stars', rarity: 'epic', chance: 10 },
                    { name: 'Редкий Самоцвет', type: 'nft', icon: '💠', rarity: 'epic', chance: 5 }
                ]
            },
            gold: {
                name: 'Золотой',
                price: 250,
                icon: '💎',
                rewards: [
                    { amount: 100, type: 'stars', rarity: 'common', chance: 25 },
                    { amount: 200, type: 'stars', rarity: 'rare', chance: 25 },
                    { name: 'Золотая Корона', type: 'nft', icon: '👑', rarity: 'epic', chance: 15 },
                    { amount: 300, type: 'stars', rarity: 'epic', chance: 15 },
                    { name: 'Легендарный Трофей', type: 'nft', icon: '🏆', rarity: 'legendary', chance: 10 },
                    { amount: 500, type: 'stars', rarity: 'legendary', chance: 10 }
                ]
            },
            diamond: {
                name: 'Алмазный',
                price: 500,
                icon: '👑',
                rewards: [
                    { amount: 250, type: 'stars', rarity: 'rare', chance: 25 },
                    { name: 'Алмазное Сердце', type: 'nft', icon: '💖', rarity: 'epic', chance: 20 },
                    { amount: 400, type: 'stars', rarity: 'epic', chance: 20 },
                    { name: 'Мифический Артефакт', type: 'nft', icon: '🔮', rarity: 'legendary', chance: 15 },
                    { amount: 800, type: 'stars', rarity: 'legendary', chance: 10 },
                    { name: 'Божественный Дар', type: 'nft', icon: '✨', rarity: 'legendary', chance: 10 }
                ]
            }
        };
        
        let currentCase = null;
        let isOpeningCase = false;
        
        function selectCase(caseType) {
            const caseData = caseTypes[caseType];
            
            if (balance < caseData.price) {
                updateStatus('❌ Недостаточно средств для открытия кейса!');
                return;
            }
            
            currentCase = caseType;
            openCase(caseData);
        }
        
        async function openCase(caseData) {
            if (isOpeningCase) return;
            isOpeningCase = true;
            
            // Списываем стоимость кейса
            try {
                const response = await fetch(`${API_URL}/api/game/place_bet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, bet_amount: caseData.price })
                });
                const data = await response.json();
                
                if (!data.success) {
                    updateStatus('❌ ' + data.error);
                    isOpeningCase = false;
                    return;
                }
                
                balance = data.balance;
                updateBalance();
            } catch (error) {
                console.error('Error opening case:', error);
                balance -= caseData.price;
                updateBalance();
            }
            
            // Показываем окно открытия
            document.getElementById('caseOpening').style.display = 'flex';
            document.getElementById('caseOpeningTitle').textContent = `Открытие ${caseData.name} кейса...`;
            document.getElementById('caseResult').style.display = 'none';
            
            // Генерируем результат
            const winReward = getRandomReward(caseData.rewards);
            
            // Создаем барабан с предметами
            createCaseReel(caseData.rewards, winReward);
            
            // Запускаем анимацию
            setTimeout(() => {
                spinCaseReel();
            }, 100);
            
            // Показываем результат через 4.5 секунды
            setTimeout(async () => {
                showCaseResult(winReward);
                
                // Начисляем выигрыш
                if (winReward.type === 'stars') {
                    try {
                        const response = await fetch(`${API_URL}/api/user/update_balance`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: userId, amount: winReward.amount })
                        });
                        const data = await response.json();
                        balance = data.balance;
                        updateBalance();
                    } catch (error) {
                        console.error('Error updating balance:', error);
                        balance += winReward.amount;
                        updateBalance();
                    }
                } else if (winReward.type === 'nft') {
                    // NFT выигран - отправляем боту для выдачи подарка
                    tg.sendData(JSON.stringify({
                        action: 'nft_won',
                        nft_name: winReward.name,
                        nft_icon: winReward.icon,
                        userId: userId
                    }));
                }
                
                isOpeningCase = false;
            }, 4500);
        }
        
        function getRandomReward(rewards) {
            const random = Math.random() * 100;
            let cumulative = 0;
            
            for (const reward of rewards) {
                cumulative += reward.chance;
                if (random <= cumulative) {
                    return reward;
                }
            }
            
            return rewards[0];
        }
        
        function createCaseReel(rewards, winReward) {
            const reel = document.getElementById('caseReel');
            reel.innerHTML = '';
            reel.style.left = '0px';
            
            // Создаем 50 предметов для барабана
            const items = [];
            for (let i = 0; i < 50; i++) {
                const reward = rewards[Math.floor(Math.random() * rewards.length)];
                items.push(reward);
            }
            
            // Вставляем выигрышный предмет в нужную позицию
            items[25] = winReward;
            
            items.forEach(reward => {
                const item = document.createElement('div');
                item.className = `case-item ${reward.rarity}`;
                
                if (reward.type === 'nft') {
                    item.innerHTML = `
                        <div class="case-item-icon">${reward.icon}</div>
                        <div class="case-item-name">${reward.name}</div>
                        <div class="case-item-type">NFT</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="case-item-amount">${reward.amount} ⭐</div>
                    `;
                }
                
                reel.appendChild(item);
            });
        }
        
        function spinCaseReel() {
            const reel = document.getElementById('caseReel');
            const containerWidth = document.querySelector('.case-reel-container').offsetWidth;
            const itemWidth = 130; // 120px + 10px margin
            
            // Рассчитываем позицию для остановки на выигрышном предмете
            const targetPosition = -(25 * itemWidth - containerWidth / 2 + itemWidth / 2);
            
            reel.style.left = targetPosition + 'px';
        }
        
        function showCaseResult(reward) {
            document.getElementById('caseResult').style.display = 'block';
            const resultAmount = document.getElementById('caseResultAmount');
            
            if (reward.type === 'nft') {
                resultAmount.innerHTML = `
                    <div style="font-size: 2em; margin-bottom: 10px;">${reward.icon}</div>
                    <div style="font-size: 0.8em; margin-bottom: 5px;">NFT Подарок</div>
                    <div>${reward.name}</div>
                `;
            } else {
                resultAmount.textContent = `${reward.amount} ⭐`;
            }
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }
        
        function closeCaseOpening() {
            document.getElementById('caseOpening').style.display = 'none';
            isOpeningCase = false;
        }
        
        // Апгрейд
        let selectedMultiplier = 1.5;
        let selectedChance = 66;
        let isUpgrading = false;
        
        function selectMultiplier(multiplier, chance) {
            selectedMultiplier = multiplier;
            selectedChance = chance;
            
            // Обновляем UI
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.multiplier-btn').classList.add('selected');
            
            // Обновляем колесо
            generateWheel(chance);
            
            // Обновляем текст в центре
            document.getElementById('wheelChanceText').textContent = chance + '%';
        }
        
        function generateWheel(winChance) {
            const wheel = document.getElementById('upgradeWheel');
            const winAngle = (winChance / 100) * 360;
            
            // Создаем градиент для колеса
            wheel.style.background = `conic-gradient(
                from 0deg,
                #4CAF50 0deg,
                #4CAF50 ${winAngle}deg,
                #f44336 ${winAngle}deg,
                #f44336 360deg
            )`;
        }
        
        async function startUpgrade() {
            if (isUpgrading) return;
            
            const betAmount = parseInt(document.getElementById('upgradeBetInput').value);
            
            if (betAmount < 10) {
                updateStatus('❌ Минимальная ставка: 10 ⭐');
                return;
            }
            
            if (betAmount > balance) {
                updateStatus('❌ Недостаточно средств!');
                return;
            }
            
            isUpgrading = true;
            document.getElementById('upgradeBtn').disabled = true;
            document.getElementById('upgradeResult').style.display = 'none';
            
            // Списываем ставку
            try {
                const response = await fetch(`${API_URL}/api/game/place_bet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, bet_amount: betAmount })
                });
                const data = await response.json();
                
                if (!data.success) {
                    updateStatus('❌ ' + data.error);
                    isUpgrading = false;
                    document.getElementById('upgradeBtn').disabled = false;
                    return;
                }
                
                balance = data.balance;
                updateBalance();
            } catch (error) {
                console.error('Error placing bet:', error);
                balance -= betAmount;
                updateBalance();
            }
            
            // Определяем результат
            const random = Math.random() * 100;
            const won = random <= selectedChance;
            
            // Крутим колесо
            spinWheel(won, betAmount);
        }
        
        function spinWheel(won, betAmount) {
            const wheel = document.getElementById('upgradeWheel');
            
            // Определяем угол остановки
            // Указатель находится сверху (0 градусов)
            // Колесо вращается, поэтому нужно инвертировать логику
            const winAngle = (selectedChance / 100) * 360;
            let targetAngle;
            
            if (won) {
                // Для выигрыша: указатель должен показывать на зеленую зону
                // Зеленая зона от 0 до winAngle
                // Поэтому колесо должно остановиться так, чтобы зеленая часть была под указателем
                targetAngle = Math.random() * winAngle;
            } else {
                // Для проигрыша: указатель должен показывать на красную зону
                // Красная зона от winAngle до 360
                targetAngle = winAngle + Math.random() * (360 - winAngle);
            }
            
            const spins = 5; // Количество полных оборотов
            // Инвертируем угол, так как колесо вращается, а указатель стоит
            const totalRotation = 360 * spins - targetAngle;
            
            wheel.style.transform = `rotate(${totalRotation}deg)`;
            
            // Показываем результат через 4 секунды
            setTimeout(async () => {
                showUpgradeResult(won, betAmount);
                
                if (won) {
                    const winAmount = Math.floor(betAmount * selectedMultiplier);
                    
                    // Начисляем выигрыш
                    try {
                        const response = await fetch(`${API_URL}/api/user/update_balance`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: userId, amount: winAmount })
                        });
                        const data = await response.json();
                        balance = data.balance;
                        updateBalance();
                    } catch (error) {
                        console.error('Error updating balance:', error);
                        balance += winAmount;
                        updateBalance();
                    }
                }
                
                isUpgrading = false;
                document.getElementById('upgradeBtn').disabled = false;
                
                // Сбрасываем колесо
                setTimeout(() => {
                    wheel.style.transition = 'none';
                    wheel.style.transform = 'rotate(0deg)';
                    setTimeout(() => {
                        wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                    }, 50);
                }, 2000);
            }, 4000);
        }
        
        function showUpgradeResult(won, betAmount) {
            const result = document.getElementById('upgradeResult');
            const title = document.getElementById('upgradeResultTitle');
            const amount = document.getElementById('upgradeResultAmount');
            
            result.style.display = 'block';
            result.className = 'upgrade-result ' + (won ? 'win' : 'lose');
            
            if (won) {
                const winAmount = Math.floor(betAmount * selectedMultiplier);
                title.textContent = '🎉 Победа!';
                amount.textContent = `+${winAmount} ⭐`;
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else {
                title.textContent = '😢 Проигрыш';
                amount.textContent = `-${betAmount} ⭐`;
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        // WebSocket события
        socket.on('connect', () => {
            console.log('✅ Подключено к серверу');
            updateStatus('✅ Подключено к серверу');
        });
        
        socket.on('connect_error', (error) => {
            console.error('❌ Ошибка подключения:', error);
            updateStatus('❌ Ошибка подключения к серверу');
        });
        
        socket.on('disconnect', () => {
            console.log('⚠️ Отключено от сервера');
            updateStatus('⚠️ Переподключение...');
        });
        
        socket.on('game_state', (state) => {
            console.log('📊 Состояние игры:', state);
            
            if (state.phase === 'betting') {
                updateStatus(`💰 Прием ставок: ${state.timer}с`);
                document.getElementById('playBtn').disabled = false;
            } else if (state.phase === 'flying') {
                serverGameActive = true;
                serverMultiplier = state.multiplier;
                updateStatus('🚀 Полет!');
                
                if (hasBet) {
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('playBtn').textContent = '💰 Забрать выигрыш';
                }
            }
            
            // Обновляем список игроков
            if (state.players && state.players.length > 0) {
                currentPlayers = state.players.filter(p => p.userId !== userId);
                updatePlayersList();
            }
        });
        
        socket.on('online_update', (data) => {
            document.getElementById('onlineUsers').textContent = data.online;
        });
        
        socket.on('betting_phase', (data) => {
            // Сброс для новой игры (через 3 секунды после краша)
            setTimeout(() => {
                hasBet = false;
                cashedOutAt = 0;
                currentPlayers = [];
                updatePlayersList();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                graphPoints = [];
                
                // ВСЕГДА включаем кнопку ставки
                document.getElementById('playBtn').disabled = false;
                document.getElementById('playBtn').textContent = '🚀 Сделать ставку';
                document.getElementById('playBtn').onclick = startGame;
                document.getElementById('betInput').disabled = false;
                document.getElementById('betInput').value = document.getElementById('betInput').value || '100';
                
                document.getElementById('multiplier').textContent = '1.00x';
                document.getElementById('multiplier').style.fontSize = '4.5em';
                document.getElementById('multiplier').style.color = '#3b82f6';
                document.getElementById('multiplier').style.opacity = '1';
                document.getElementById('multiplier').classList.remove('growing');
                document.getElementById('crashText').style.display = 'none';
                document.getElementById('rocket').classList.remove('crashed');
                document.getElementById('rocket').style.bottom = '25px';
                
                updateStatus(`💰 Прием ставок: ${data.timer}с`);
            }, 3000);
        });
        
        socket.on('timer_update', (data) => {
            if (data.timer <= 5 && data.timer > 0) {
                // Обратный отсчет на экране
                const multiplierEl = document.getElementById('multiplier');
                multiplierEl.style.fontSize = '6em';
                multiplierEl.style.color = '#3b82f6';
                multiplierEl.textContent = data.timer;
                multiplierEl.classList.add('growing');
                
                // Блокируем ставки за 5 секунд
                if (!hasBet) {
                    document.getElementById('playBtn').disabled = true;
                    document.getElementById('betInput').disabled = true;
                }
                
                updateStatus(`🚀 Запуск через ${data.timer}...`);
                
                // Мигание
                multiplierEl.style.opacity = '0.3';
                setTimeout(() => {
                    multiplierEl.style.opacity = '1';
                }, 300);
            } else if (data.timer > 5) {
                updateStatus(`💰 Прием ставок: ${data.timer}с`);
            }
        });
        
        socket.on('game_started', () => {
            serverGameActive = true;
            gameStartTime = Date.now();
            graphPoints = [];
            
            // Сбрасываем размер множителя
            const multiplierEl = document.getElementById('multiplier');
            multiplierEl.style.fontSize = '4.5em';
            multiplierEl.style.opacity = '1';
            multiplierEl.textContent = '1.00x';
            
            if (hasBet) {
                document.getElementById('playBtn').textContent = '💰 Забрать выигрыш';
                document.getElementById('playBtn').onclick = cashout;
                document.getElementById('playBtn').disabled = false;
            } else {
                document.getElementById('playBtn').disabled = true;
            }
            
            updateStatus('🚀 Полет!');
        });
        
        socket.on('multiplier_update', (data) => {
            multiplier = data.multiplier;
            const multiplierEl = document.getElementById('multiplier');
            multiplierEl.textContent = multiplier.toFixed(2) + 'x';
            multiplierEl.classList.add('growing');
            multiplierEl.style.fontSize = '3em'; // Меньший размер
            
            if (multiplier < 2) multiplierEl.style.color = '#3b82f6';
            else if (multiplier < 5) multiplierEl.style.color = '#22c55e';
            else if (multiplier < 10) multiplierEl.style.color = '#eab308';
            else multiplierEl.style.color = '#ef4444';
            
            graphPoints.push({ x: (Date.now() - gameStartTime) / 1000, y: multiplier });
            drawGraph();
            updateRocketPosition();
        });
        
        socket.on('player_bet', (player) => {
            // Добавляем всех игроков включая себя
            const existingPlayer = currentPlayers.find(p => p.name === player.name);
            if (!existingPlayer) {
                currentPlayers.push({
                    name: player.name,
                    bet: player.bet,
                    result: null,
                    cashout: null
                });
                updatePlayersList();
            }
        });
        
        socket.on('player_cashout', (data) => {
            const player = currentPlayers.find(p => p.name === data.name);
            if (player) {
                player.cashout = data.multiplier;
                player.result = true;
                updatePlayersList();
            }
        });
        
        socket.on('game_crashed', (data) => {
            serverGameActive = false;
            multiplier = data.crashPoint;
            
            document.getElementById('multiplier').classList.remove('growing');
            document.getElementById('multiplier').textContent = data.crashPoint.toFixed(2) + 'x';
            document.getElementById('multiplier').style.fontSize = '4.5em';
            document.getElementById('multiplier').style.color = '#ef4444';
            document.getElementById('rocket').classList.add('crashed');
            
            // Убираем дублирующийся текст краша
            const crashText = document.getElementById('crashText');
            crashText.style.display = 'none';
            
            if (hasBet && cashedOutAt === 0) {
                updateStatus(`💥 Краш на ${data.crashPoint.toFixed(2)}x! Вы проиграли ${currentBet} ⭐`);
                recordGameResult(false, currentBet, 0, 0);
            } else if (cashedOutAt > 0) {
                updateStatus(`✅ Вы забрали на ${cashedOutAt.toFixed(2)}x | Краш: ${data.crashPoint.toFixed(2)}x`);
            } else {
                updateStatus(`💥 Краш на ${data.crashPoint.toFixed(2)}x!`);
            }
            
            // Обновляем историю только один раз
            if (!gameHistory.includes(data.crashPoint)) {
                gameHistory.unshift(data.crashPoint);
                if (gameHistory.length > 8) gameHistory = gameHistory.slice(0, 8);
                updateHistoryBar();
            }
        });
        
        // Загрузка при старте
        async function initApp() {
            console.log('🚀 Инициализация приложения');
            await loadBalance();
            await loadHistory();
            await loadPlayerStats();
            await checkBonusStatus();
            initPlinko();
            createRouletteStrip();
            createNumberButtons();
            console.log('✅ Приложение готово');
            updateStatus('💰 Ожидание начала игры...');
        }
        
        async function checkBonusStatus() {
            try {
                const response = await fetch(`${API_URL}/api/user/claim_bonus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                
                if (!data.success && data.secondsLeft) {
                    startBonusTimer(data.secondsLeft);
                }
            } catch (error) {
                console.error('Error checking bonus:', error);
            }
        }
        
        initApp();
        
        // Обновление онлайн пользователей каждые 10 секунд
        setInterval(updateOnlineUsers, 10000);
        
        // Начальная позиция ракеты
        const rocket = document.getElementById('rocket');
        rocket.style.bottom = '25px';
        rocket.style.transform = 'translateX(-50%)';
        document.getElementById('crashText').classList.remove('show');
        
        // Предотвращаем зум на iOS
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });
        
        // Начальное состояние
        updateStatus('💰 Ожидание ставок...');
        
        // ============ ЛИНЕЙНАЯ РУЛЕТКА ============
        const rouletteNumbers = [0, 28, 9, 26, 30, 11, 7, 20, 32, 17, 5, 22, 34, 15, 3, 24, 36, 13, 1, '00', 27, 10, 25, 29, 12, 8, 19, 31, 18, 6, 21, 33, 16, 4, 23, 35, 14, 2];
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        const blackNumbers = [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35];
        let rouletteHistory = [];
        let rouletteBetsHistory = [];
        let isRouletteSpinning = false;
        let selectedRouletteBets = []; // Массив для множественных ставок
        let roulettePhase = 'betting';
        
        function getNumberColor(num) {
            if (num === 0 || num === '00') return 'green';
            if (redNumbers.includes(num)) return 'red';
            return 'black';
        }
        
        function selectRouletteBet(type) {
            // Проверяем есть ли уже эта ставка
            const index = selectedRouletteBets.findIndex(b => b.type === type);
            
            if (index >= 0) {
                // Убираем ставку
                selectedRouletteBets.splice(index, 1);
            } else {
                // Добавляем ставку (максимум 3)
                if (selectedRouletteBets.length >= 3) {
                    updateStatus('❌ Максимум 3 ставки!');
                    return;
                }
                selectedRouletteBets.push({ type, amount: 0 });
            }
            
            // Обновляем UI
            updateRouletteBetButtons();
        }
        
        function updateRouletteBetButtons() {
            document.querySelectorAll('.roulette-bet-btn').forEach(btn => {
                const type = btn.getAttribute('data-type');
                const isSelected = selectedRouletteBets.some(b => b.type == type);
                
                if (isSelected) {
                    btn.style.borderColor = '#fbbf24';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.borderColor = 'transparent';
                    btn.style.transform = 'scale(1)';
                }
            });
        }
        
        async function placeRouletteBet() {
            if (roulettePhase !== 'betting') {
                updateStatus('❌ Ставки закрыты!');
                return;
            }
            
            if (selectedRouletteBets.length === 0) {
                updateStatus('❌ Выберите ставку!');
                return;
            }
            
            const betAmount = parseInt(document.getElementById('rouletteBetInput').value);
            
            if (betAmount < 10) {
                updateStatus('❌ Минимальная ставка: 10 ⭐');
                return;
            }
            
            const totalAmount = betAmount * selectedRouletteBets.length;
            
            if (totalAmount > balance) {
                updateStatus('❌ Недостаточно средств!');
                return;
            }
            
            const userName = tg.initDataUnsafe?.user?.first_name || 'Игрок';
            
            // Отправляем все ставки на сервер
            for (const bet of selectedRouletteBets) {
                socket.emit('roulette_bet', {
                    userId: userId,
                    amount: betAmount,
                    type: bet.type,
                    name: userName
                });
            }
            
            // Очищаем выбор
            selectedRouletteBets = [];
            updateRouletteBetButtons();
        }
        
        // Создаем бегущую строку с числами
        function createRouletteStrip() {
            const strip = document.getElementById('rouletteStrip');
            if (!strip) return;
            
            strip.innerHTML = '';
            
            // Создаем массив чисел (повторяем 10 раз для бесшовной прокрутки)
            const repeatedNumbers = [];
            for (let i = 0; i < 10; i++) {
                repeatedNumbers.push(...rouletteNumbers);
            }
            
            repeatedNumbers.forEach(num => {
                const color = getNumberColor(num);
                const bgColor = color === 'red' ? '#dc2626' : color === 'black' ? '#1a1a1a' : '#16a34a';
                
                const cell = document.createElement('div');
                cell.style.cssText = `
                    width: 50px;
                    height: 60px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: ${bgColor};
                    border-right: 2px solid #fbbf24;
                    font-size: 1.5em;
                    font-weight: bold;
                    color: white;
                    flex-shrink: 0;
                    box-sizing: border-box;
                `;
                cell.textContent = num;
                strip.appendChild(cell);
            });
        }
        
        // Создаем кнопки выбора чисел
        function createNumberButtons() {
            const container = document.querySelector('[style*="grid-template-columns: repeat(8, 1fr)"]');
            if (!container) return;
            
            // Добавляем остальные числа (5-36)
            for (let i = 5; i <= 36; i++) {
                const color = getNumberColor(i);
                const bgColor = color === 'red' ? '#dc2626' : '#1a1a1a';
                
                const btn = document.createElement('button');
                btn.onclick = () => selectRouletteBet(i);
                btn.className = 'roulette-bet-btn';
                btn.setAttribute('data-type', i);
                btn.style.cssText = `padding: 6px 4px; background: ${bgColor}; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.75em;`;
                btn.textContent = i;
                container.appendChild(btn);
            }
        }
        
        function spinRouletteWheel(targetNumber, callback) {
            const strip = document.getElementById('rouletteStrip');
            if (!strip) return;
            
            const targetIndex = rouletteNumbers.indexOf(targetNumber);
            
            // Измеряем реальную ширину первой ячейки (50px + 2px border = 52px)
            const firstCell = strip.children[0];
            if (!firstCell) return;
            const cellWidth = firstCell.offsetWidth;
            
            console.log('📏 Ширина ячейки:', cellWidth + 'px');
            
            // Находим позицию целевого числа в середине массива (5-й повтор)
            const middleRepeat = 5;
            const targetCellIndex = middleRepeat * rouletteNumbers.length + targetIndex;
            
            // Позиция левого края целевой ячейки
            const targetCellLeft = targetCellIndex * cellWidth;
            
            // Центр целевой ячейки
            const targetCellCenter = targetCellLeft + cellWidth / 2;
            
            // Центр контейнера
            const container = strip.parentElement;
            const containerCenter = container.offsetWidth / 2;
            
            // Финальная позиция strip.left чтобы центр ячейки совпал с центром контейнера
            const finalPosition = containerCenter - targetCellCenter;
            
            console.log('🎯 Целевое число:', targetNumber, '(индекс', targetIndex + ')');
            console.log('📍 Индекс ячейки:', targetCellIndex);
            console.log('📐 Позиция ячейки:', targetCellLeft + 'px');
            console.log('🎪 Центр ячейки:', targetCellCenter + 'px');
            console.log('🏁 Финальная позиция:', finalPosition + 'px');
            
            // Начальная позиция (справа, за экраном)
            const startPosition = container.offsetWidth;
            
            // Сбрасываем transition и устанавливаем начальную позицию
            strip.style.transition = 'none';
            strip.style.left = startPosition + 'px';
            
            // Запускаем анимацию через небольшую задержку
            setTimeout(() => {
                strip.style.transition = 'left 4s cubic-bezier(0.25, 0.1, 0.25, 1)';
                strip.style.left = finalPosition + 'px';
                
                // После остановки показываем результат
                setTimeout(() => {
                    console.log('✅ Результат:', targetNumber);
                    console.log('✓ Совпадение!');
                    
                    if (callback) callback();
                }, 4000);
            }, 50);
        }
        
        async function playRoulette() {
            if (isRouletteSpinning) return;
            
            const betAmount = parseInt(document.getElementById('rouletteBetInput').value);
            const betType = document.getElementById('rouletteBetType').value;
            
            if (betAmount < 10) {
                updateStatus('❌ Минимальная ставка: 10 ⭐');
                return;
            }
            
            if (betAmount > balance) {
                updateStatus('❌ Недостаточно средств!');
                return;
            }
            
            isRouletteSpinning = true;
            document.getElementById('rouletteBtn').disabled = true;
            balance -= betAmount;
            updateBalance();
            
            const random = Math.random();
            let resultNumber;
            
            if (betType === 'green') {
                resultNumber = random < 0.0526 ? (random < 0.0263 ? 0 : '00') : (random < 0.5 ? redNumbers[Math.floor(Math.random() * redNumbers.length)] : blackNumbers[Math.floor(Math.random() * blackNumbers.length)]);
            } else if (betType === 'red') {
                resultNumber = random < 0.4737 ? redNumbers[Math.floor(Math.random() * redNumbers.length)] : (random < 0.9474 ? blackNumbers[Math.floor(Math.random() * blackNumbers.length)] : (random < 0.9737 ? 0 : '00'));
            } else {
                resultNumber = random < 0.4737 ? blackNumbers[Math.floor(Math.random() * blackNumbers.length)] : (random < 0.9474 ? redNumbers[Math.floor(Math.random() * redNumbers.length)] : (random < 0.9737 ? 0 : '00'));
            }
            
            spinRouletteWheel(resultNumber, async () => {
                const resultColor = getNumberColor(resultNumber);
                const won = (betType === 'red' && resultColor === 'red') || (betType === 'black' && resultColor === 'black') || (betType === 'green' && resultColor === 'green');
                
                const resultEl = document.getElementById('rouletteResult');
                resultEl.textContent = resultNumber;
                resultEl.style.color = resultColor === 'red' ? '#dc2626' : resultColor === 'black' ? '#1a1a1a' : '#16a34a';
                resultEl.style.display = 'block';
                
                setTimeout(() => {
                    resultEl.style.display = 'none';
                }, 3000);
                
                rouletteHistory.unshift(resultNumber);
                if (rouletteHistory.length > 10) rouletteHistory.pop();
                updateRouletteHistory();
                
                let winAmount = 0;
                if (won) {
                    winAmount = betType === 'green' ? betAmount * 18 : betAmount * 2;
                    balance += winAmount;
                    updateBalance();
                    updateStatus(`🎉 Выпало ${resultNumber}! Выигрыш: ${winAmount} ⭐`);
                } else {
                    updateStatus(`😢 Выпало ${resultNumber}. Проигрыш: ${betAmount} ⭐`);
                }
                
                const betInfo = {
                    bet: betAmount,
                    type: betType,
                    result: resultNumber,
                    won: won,
                    winAmount: winAmount
                };
                rouletteBetsHistory.unshift(betInfo);
                if (rouletteBetsHistory.length > 20) rouletteBetsHistory.pop();
                updateRouletteBets();
                
                isRouletteSpinning = false;
                document.getElementById('rouletteBtn').disabled = false;
            });
        }
        
        function updateRouletteHistory() {
            const historyEl = document.getElementById('rouletteHistory');
            historyEl.innerHTML = rouletteHistory.map(num => {
                const color = getNumberColor(num);
                const bgColor = color === 'red' ? '#dc2626' : color === 'black' ? '#1a1a1a' : '#16a34a';
                return `<div style="min-width: 32px; height: 32px; background: ${bgColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85em; border: 2px solid #fbbf24;">${num}</div>`;
            }).join('');
        }
        
        function updateRouletteBets() {
            const betsEl = document.getElementById('rouletteBets');
            if (rouletteBetsHistory.length === 0) {
                betsEl.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 10px;">История ставок появится здесь</div>';
                return;
            }
            
            betsEl.innerHTML = rouletteBetsHistory.map(bet => {
                let typeText;
                let typeBg;
                
                if (bet.type === 'red') {
                    typeText = '🔴';
                    typeBg = '#dc2626';
                } else if (bet.type === 'black') {
                    typeText = '⚫';
                    typeBg = '#1a1a1a';
                } else {
                    // Конкретное число
                    const color = getNumberColor(bet.type);
                    typeBg = color === 'red' ? '#dc2626' : color === 'black' ? '#1a1a1a' : '#16a34a';
                    typeText = bet.type;
                }
                
                const borderColor = bet.won === null ? 'rgba(59, 130, 246, 0.3)' : (bet.won ? '#22c55e' : '#ef4444');
                
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 4px; background: rgba(30, 35, 45, 0.6); border-radius: 6px; border-left: 3px solid ${borderColor};">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="min-width: 50px; padding: 4px 8px; background: ${typeBg}; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.75em; border: 1px solid #fbbf24;">${typeText}</div>
                        <span style="font-weight: bold; color: rgba(255,255,255,0.9);">${bet.name}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: rgba(255,255,255,0.6);">${bet.amount} ⭐</span>
                    </div>
                </div>`;
            }).join('');
        }
        
        // ============ WEBSOCKET РУЛЕТКА ============
        socket.on('roulette_state', (state) => {
            roulettePhase = state.phase;
            updateRouletteTimer(state.timer, state.phase);
        });
        
        socket.on('roulette_timer', (data) => {
            updateRouletteTimer(data.timer, roulettePhase);
        });
        
        socket.on('roulette_spin', (data) => {
            isRouletteSpinning = true;
            document.getElementById('rouletteBtn').disabled = true;
            spinRouletteWheel(data.resultNumber, () => {
                isRouletteSpinning = false;
            });
        });
        
        socket.on('roulette_result', (data) => {
            rouletteHistory.unshift(data.number);
            if (rouletteHistory.length > 10) rouletteHistory.pop();
            updateRouletteHistory();
            
            const resultEl = document.getElementById('rouletteResult');
            resultEl.textContent = data.number;
            resultEl.style.color = data.color === 'red' ? '#dc2626' : data.color === 'black' ? '#1a1a1a' : '#16a34a';
            resultEl.style.display = 'block';
            
            // Очищаем историю ставок после результата
            rouletteBetsHistory = [];
            updateRouletteBets();
            
            setTimeout(() => {
                resultEl.style.display = 'none';
                document.getElementById('rouletteBtn').disabled = false;
            }, 3000);
        });
        
        socket.on('roulette_bet_placed', (data) => {
            const betInfo = {
                name: data.name,
                amount: data.amount,
                type: data.type,
                result: null,
                won: null,
                winAmount: 0
            };
            rouletteBetsHistory.unshift(betInfo);
            if (rouletteBetsHistory.length > 20) rouletteBetsHistory.pop();
            updateRouletteBets();
        });
        
        socket.on('roulette_bet_success', (data) => {
            balance = data.balance;
            updateBalance();
            updateStatus('✅ Ставка принята!');
        });
        
        socket.on('roulette_win', (data) => {
            balance += data.amount;
            updateBalance();
            updateStatus(`🎉 Выпало ${data.number}! Выигрыш: ${data.amount} ⭐`);
        });
        
        socket.on('roulette_error', (data) => {
            updateStatus('❌ ' + data.message);
        });
        
        function updateRouletteTimer(timer, phase) {
            const timerEl = document.getElementById('rouletteTimer');
            
            if (phase === 'betting') {
                timerEl.textContent = `💰 Прием ставок: ${timer}с`;
                timerEl.style.background = 'rgba(34, 197, 94, 0.1)';
                timerEl.style.borderColor = 'rgba(34, 197, 94, 0.2)';
            } else if (phase === 'countdown') {
                timerEl.textContent = `⏱️ Запуск через ${timer}...`;
                timerEl.style.background = 'rgba(255, 193, 7, 0.1)';
                timerEl.style.borderColor = 'rgba(255, 193, 7, 0.2)';
                timerEl.style.fontSize = '1.2em';
            } else if (phase === 'spinning') {
                timerEl.textContent = '🎰 Рулетка крутится...';
                timerEl.style.background = 'rgba(59, 130, 246, 0.1)';
                timerEl.style.borderColor = 'rgba(59, 130, 246, 0.2)';
            } else if (phase === 'result') {
                timerEl.textContent = '✅ Результат!';
                timerEl.style.background = 'rgba(139, 92, 246, 0.1)';
                timerEl.style.borderColor = 'rgba(139, 92, 246, 0.2)';
            }
        }
        
        // ============ БОНУСЫ ============
        let bonusInterval = null;
        
        async function claimBonus() {
            const btn = document.getElementById('bonusBtn');
            if (btn.disabled) return; // Если кнопка заблокирована - не даём нажать
            
            try {
                const response = await fetch(`${API_URL}/api/user/claim_bonus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                
                if (data.success) {
                    balance = data.balance;
                    updateBalance();
                    updateStatus(`🎁 Получено ${data.bonus} ⭐!`);
                    startBonusTimer(3600); // Запускаем таймер на 1 час
                } else {
                    updateStatus('❌ ' + data.error);
                    if (data.secondsLeft) {
                        startBonusTimer(data.secondsLeft);
                    }
                }
            } catch (error) {
                console.error('Error claiming bonus:', error);
                updateStatus('❌ Ошибка сервера');
            }
        }
        
        function startBonusTimer(secondsLeft) {
            const btn = document.getElementById('bonusBtn');
            const timer = document.getElementById('bonusTimer');
            
            // Блокируем кнопку
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.style.background = 'rgba(100, 100, 100, 0.3)';
            timer.style.display = 'block';
            
            // Очищаем старый интервал если есть
            if (bonusInterval) {
                clearInterval(bonusInterval);
            }
            
            let timeLeft = secondsLeft;
            
            const updateTimer = () => {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                
                document.getElementById('bonusTimeLeft').textContent = 
                    `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(bonusInterval);
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                    timer.style.display = 'none';
                    bonusInterval = null;
                }
                
                timeLeft--;
            };
            
            updateTimer(); // Сразу обновляем
            bonusInterval = setInterval(updateTimer, 1000);
            }, 1000);
        }
        
        // ============ АДМИН ============
        async function toggleAdminUsersList() {
            const listEl = document.getElementById('adminUsersList');
            if (listEl.style.display === 'none') {
                listEl.style.display = 'block';
                await loadAdminUsersList();
            } else {
                listEl.style.display = 'none';
            }
        }
        
        async function loadAdminUsersList() {
            try {
                const response = await fetch(`${API_URL}/api/admin/get_users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_id: userId })
                });
                const data = await response.json();
                
                if (data.success) {
                    const listEl = document.getElementById('adminUsersList');
                    listEl.innerHTML = data.users.map(user => `
                        <div onclick="document.getElementById('adminTargetId').value='${user.user_id}'" style="padding: 8px; margin-bottom: 4px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; cursor: pointer; border: 1px solid rgba(139, 92, 246, 0.2); transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'">
                            <div style="font-weight: bold; color: #8b5cf6; font-size: 0.9em;">${user.username || 'Игрок'}</div>
                            <div style="font-size: 0.75em; color: rgba(255,255,255,0.5);">ID: ${user.user_id}</div>
                            <div style="font-size: 0.75em; color: rgba(255,255,255,0.6);">Баланс: ${user.balance} ⭐</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function adminGiveCurrency() {
            const targetId = document.getElementById('adminTargetId').value;
            const amount = parseInt(document.getElementById('adminAmount').value);
            
            if (!targetId || !amount) {
                updateStatus('❌ Заполните все поля');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/admin/give_currency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_id: userId,
                        target_user_id: targetId,
                        amount: amount
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(`✅ Выдано ${amount} ⭐ игроку ${targetId.substring(0, 8)}...`);
                    document.getElementById('adminTargetId').value = '';
                    if (document.getElementById('adminUsersList').style.display === 'block') {
                        loadAdminUsersList();
                    }
                } else {
                    updateStatus('❌ ' + data.error);
                }
            } catch (error) {
                console.error('Error giving currency:', error);
                updateStatus('❌ Ошибка сервера');
            }
        }
        
        async function adminTakeCurrency() {
            const targetId = document.getElementById('adminTargetId').value;
            const amount = parseInt(document.getElementById('adminAmount').value);
            
            if (!targetId || !amount) {
                updateStatus('❌ Заполните все поля');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/admin/give_currency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_id: userId,
                        target_user_id: targetId,
                        amount: -amount
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(`✅ Забрано ${amount} ⭐ у игрока ${targetId.substring(0, 8)}...`);
                    document.getElementById('adminTargetId').value = '';
                    if (document.getElementById('adminUsersList').style.display === 'block') {
                        loadAdminUsersList();
                    }
                } else {
                    updateStatus('❌ ' + data.error);
                }
            } catch (error) {
                console.error('Error taking currency:', error);
                updateStatus('❌ Ошибка сервера');
            }
        }
        
        // Показываем админ панель для админа
        if (userId === '840879061') {
            document.getElementById('adminPanel').style.display = 'block';
        }
        
        // ============ РЕЙТИНГ ============
        async function loadLeaderboard(type) {
            try {
                const response = await fetch(`${API_URL}/api/leaderboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type })
                });
                const data = await response.json();
                
                if (data.success) {
                    displayLeaderboard(data.leaderboard, type);
                }
                
                // Обновляем активную вкладку
                document.querySelectorAll('.rating-tab').forEach(btn => {
                    btn.style.background = 'rgba(30, 35, 45, 0.6)';
                    btn.style.border = '2px solid rgba(59, 130, 246, 0.3)';
                });
                
                const activeBtn = type === 'balance' ? document.getElementById('ratingBalance') : document.getElementById('ratingWins');
                activeBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                activeBtn.style.border = 'none';
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }
        
        function displayLeaderboard(players, type) {
            const listEl = document.getElementById('leaderboardList');
            
            if (players.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px;">Нет данных</div>';
                return;
            }
            
            listEl.innerHTML = players.map((player, index) => {
                const isCurrentUser = player.user_id === userId;
                const isTop3 = index < 3;
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                const value = type === 'balance' ? `${player.balance} ⭐` : `${player.total_wins} 🏆`;
                const displayName = player.username || 'Игрок';
                
                // Разные цвета для топ-3
                let bgGradient, borderColor, glowColor, medalSize, textColor;
                if (index === 0) {
                    // Золото
                    bgGradient = 'linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 193, 7, 0.2) 100%)';
                    borderColor = '2px solid rgba(255, 215, 0, 0.7)';
                    glowColor = '0 0 25px rgba(255, 215, 0, 0.5), 0 0 50px rgba(255, 215, 0, 0.3)';
                    medalSize = '2em';
                    textColor = '#ffd700';
                } else if (index === 1) {
                    // Серебро
                    bgGradient = 'linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(169, 169, 169, 0.2) 100%)';
                    borderColor = '2px solid rgba(192, 192, 192, 0.7)';
                    glowColor = '0 0 20px rgba(192, 192, 192, 0.4), 0 0 40px rgba(192, 192, 192, 0.2)';
                    medalSize = '1.8em';
                    textColor = '#c0c0c0';
                } else if (index === 2) {
                    // Бронза
                    bgGradient = 'linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(184, 115, 51, 0.2) 100%)';
                    borderColor = '2px solid rgba(205, 127, 50, 0.7)';
                    glowColor = '0 0 20px rgba(205, 127, 50, 0.4), 0 0 40px rgba(205, 127, 50, 0.2)';
                    medalSize = '1.6em';
                    textColor = '#cd7f32';
                } else {
                    bgGradient = isCurrentUser ? 'rgba(59, 130, 246, 0.2)' : 'rgba(30, 35, 45, 0.6)';
                    borderColor = isCurrentUser ? '2px solid rgba(59, 130, 246, 0.5)' : '1px solid rgba(59, 130, 246, 0.2)';
                    glowColor = 'none';
                    medalSize = '1.2em';
                    textColor = isCurrentUser ? '#3b82f6' : 'white';
                }
                
                const glowClass = index === 0 ? 'top1-glow' : index === 1 ? 'top2-glow' : index === 2 ? 'top3-glow' : '';
                
                return `<div class="leaderboard-item ${glowClass}" style="display: flex; justify-content: space-between; align-items: center; padding: ${isTop3 ? '15px' : '12px'}; background: ${bgGradient}; border-radius: ${isTop3 ? '15px' : '10px'}; border: ${borderColor}; position: relative; overflow: hidden; transition: all 0.3s ease;">
                    ${isTop3 ? '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%); animation: shine 3s infinite;"></div>' : ''}
                    <div style="display: flex; align-items: center; gap: ${isTop3 ? '15px' : '10px'}; position: relative; z-index: 1;">
                        <span style="font-size: ${medalSize}; min-width: ${isTop3 ? '45px' : '35px'}; text-align: center; ${isTop3 ? 'filter: drop-shadow(0 0 10px ' + textColor + ');' : ''}">${medal}</span>
                        <div>
                            <div style="font-weight: bold; color: ${isTop3 ? textColor : textColor}; font-size: ${isTop3 ? '1.1em' : '1em'}; ${isTop3 ? 'text-shadow: 0 2px 10px rgba(0,0,0,0.7);' : ''}">${displayName}</div>
                            <div style="font-size: 0.85em; color: rgba(255,255,255,0.6);">Игр: ${player.total_games}</div>
                        </div>
                    </div>
                    <div style="font-weight: bold; color: ${isTop3 ? textColor : '#3b82f6'}; font-size: ${isTop3 ? '1.3em' : '1.1em'}; position: relative; z-index: 1; ${isTop3 ? 'text-shadow: 0 2px 10px rgba(0,0,0,0.7);' : ''}">${value}</div>
                </div>`;
            }).join('');
        }
        
        // Лента выигрышей
        async function loadWinsFeed() {
            try {
                const response = await fetch(`${API_URL}/api/wins_feed`);
                const data = await response.json();
                
                if (data.success && data.wins.length > 0) {
                    const feedEl = document.getElementById('winsFeed');
                    const items = data.wins.map(win => {
                        const gameIcon = win.game === 'crash' ? '🚀' : win.game === 'plinko' ? '🎯' : '🎰';
                        return `<div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(34, 197, 94, 0.15); border-radius: 20px; border: 1px solid rgba(34, 197, 94, 0.4);">
                            <span style="font-size: 1.1em;">${gameIcon}</span>
                            <span style="font-size: 0.85em; font-weight: bold; color: white;">ID: ${win.user_id.substring(0, 6)}...</span>
                            <span style="font-size: 0.9em; font-weight: bold; color: #22c55e;">${win.multiplier}x</span>
                        </div>`;
                    }).join('');
                    // Дублируем для бесшовной прокрутки
                    feedEl.innerHTML = items + items;
                }
            } catch (error) {
                console.error('Error loading wins feed:', error);
            }
        }
        
        // Применение темы Telegram
        document.body.style.background = tg.themeParams.bg_color || document.body.style.background;
    </script>
</body>
</html>

